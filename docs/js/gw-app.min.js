!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GWA={})}(this,(function(t){"use strict";class e{constructor(t,e){this.target=null,this.defaultPrevented=void 0,this.propagationStopped=void 0,this.key="",this.code="",this.shiftKey=!1,this.ctrlKey=!1,this.altKey=!1,this.metaKey=!1,this.dir=null,this.x=-1,this.y=-1,this.clientX=-1,this.clientY=-1,this.dt=0,this.reset(t,e)}doDefault(){this.defaultPrevented=!1}preventDefault(){this.defaultPrevented=!0}propagate(){this.propagationStopped=!1}stopPropagation(){this.propagationStopped=!0}reset(t,e){this.type=t,this.target=null,this.defaultPrevented=void 0,this.propagationStopped=void 0,this.shiftKey=!1,this.ctrlKey=!1,this.altKey=!1,this.metaKey=!1,this.key="",this.code="",this.x=-1,this.y=-1,this.dir=null,this.dt=0,this.target=null,e&&Object.assign(this,e)}clone(){return new e(this.type,this)}dispatch(t){let e=!1;return this.type===i&&(this.dir&&t.emit("dir",this)&&(e=!0),this.propagationStopped||t.emit(this.key,this)&&(e=!0),this.code!==this.key&&(this.propagationStopped||t.emit(this.code,this)&&(e=!0)),this.defaultPrevented||this.propagationStopped)||t.emit(this.type,this)&&(e=!0),e}}const s=[],i="keypress",h="mousemove",n="click",r="tick",a="mouseup",o="stop",d=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight","Enter","Delete","Backspace","Tab","CapsLock","Escape"];function l(t){return"string"==typeof t?d.includes(t):d.includes(t.code)}function u(t){s.push(t)}function c(t,i){const h=s.pop()||null;return h?(h.reset(t,i),h):new e(t,i)}function f(t){let h=t.key,n=t.code;t.shiftKey&&(h=h.toUpperCase()),t.ctrlKey&&(h="^"+h),t.metaKey&&(h="#"+h),t.altKey;const r=s.pop()||new e(i);return r.shiftKey=t.shiftKey,r.ctrlKey=t.ctrlKey,r.altKey=t.altKey,r.metaKey=t.metaKey,r.type=i,r.defaultPrevented=void 0,r.propagationStopped=void 0,r.key=h,r.code=n,r.x=-1,r.y=-1,r.clientX=-1,r.clientY=-1,r.dir=p(t.code),r.dt=0,r.target=null,r}function p(t){const e=t.toLowerCase();return"arrowup"===e?[0,-1]:"arrowdown"===e?[0,1]:"arrowleft"===e?[-1,0]:"arrowright"===e?[1,0]:null}function g(t,i,h){const r=s.pop()||new e(t.type);return r.shiftKey=t.shiftKey,r.ctrlKey=t.ctrlKey,r.altKey=t.altKey,r.metaKey=t.metaKey,r.type=t.type||"mousemove",t.buttons&&"mouseup"!==t.type&&(r.type=n),r.defaultPrevented=void 0,r.propagationStopped=void 0,r.key="",r.code="",r.x=i,r.y=h,r.clientX=t.clientX,r.clientY=t.clientY,r.dir=null,r.dt=0,r.target=null,r}class _{constructor(){this.lastClick={x:-1,y:-1},this._events=[]}get length(){return this._events.length}clear(){this._events.length=0}enqueue(t){if(this._events.length){const e=this._events[this._events.length-1];if(e.type===t.type&&e.type===h)return e.x=t.x,e.y=t.y,void u(t)}if(t.type===n){if(this.lastClick.x==t.x&&this.lastClick.y==t.y&&this._events.findIndex((t=>t.type===n))>=0)return void u(t);this.lastClick.x=t.x,this.lastClick.y=t.y}else if(t.type==a)return this.lastClick.x=-1,this.lastClick.y=-1,void u(t);if(t.type===r){const e=this._events[0];if(e&&e.type===r)return e.dt+=t.dt,void u(t);this._events.unshift(t)}else this._events.push(t)}dequeue(){return this._events.shift()}peek(){return this._events[0]}}function b(){}function m(){return!0}function y(t){return t}function w(t,e,s){return t<e?e:t>s?s:t}function x(t,e){const s=t.indexOf(e);return!(s<0)&&(t.splice(s,1),!0)}function v(t,e){const s=t.indexOf(e);return!(s<0)&&(t[s]=null,!0)}function E(t,e){for(let s=t.length-1;s>=0;--s){const i=t[s];if(e(i))return i}}function S(t,e,s,i=!0,h=!0){const n=t.length;if(n<=1)return;const r=t.indexOf(e);if(r<0)return;const a=h?1:-1;let o=i?r:h?n:-1;for(let e=i?(n+r+a)%n:r+a;e!==o;e=i?(n+e+a)%n:e+a){const i=t[e];if(s(i))return i}}class T{constructor(t,e){this._events={},this.onUnhandled=null,this._ctx=t,e&&this.on(e)}has(t){const e=this._events[t];return!!e&&e.some((t=>t&&t.fn))}on(...t){if(1===t.length){const e=Object.entries(t[0]).map((([t,e])=>this.on(t,e)));return()=>e.forEach((t=>t()))}const e=t[0],s=t[1];if(Array.isArray(e)){const t=e.map((t=>this.on(t,s)));return()=>{t.forEach((t=>t()))}}e in this._events||(this._events[e]=[]);const i={fn:s};return this._events[e].unshift(i),()=>{v(this._events[e],i)}}once(t,e){if(Array.isArray(t)){const s=t.map((t=>this.on(t,e)));return()=>{s.forEach((t=>t()))}}t in this._events||(this._events[t]=[]);const s={fn:e,once:!0};return this._events[t].unshift(s),()=>{v(this._events[t],s)}}off(t,e){if(Array.isArray(t))return void t.forEach((t=>this.off(t,e)));const s=this._events[t];if(!s)return;if(!e){for(let t=0;t<s.length;++t)s[t]=null;return}const i=s.findIndex((t=>t&&t.fn===e));i>-1&&(s[i]=null)}emit(t,...e){if(Array.isArray(t)){let s=!1;for(let i of t)s=this.emit(i,...e)||s;return s}const s=this._events[t];return s&&0!=s.length?(s.forEach((t=>{t&&t.fn.call(this._ctx,...e)})),this._events[t]=s.filter((t=>t&&!t.once)),!0):this._unhandled(t,e)}_unhandled(t,e){return!!this.onUnhandled&&(this.onUnhandled.call(this._ctx,t,...e),!0)}clear(){this._events={},this.onUnhandled=null}clear_event(t){t in this._events&&(this._events[t]=this._events[t].map((()=>null)))}restart(){Object.keys(this._events).forEach((t=>{this._events[t]=this._events[t].filter((t=>t&&!t.once))})),this.onUnhandled=null}}class k{constructor(){this._timer=0}get isRunning(){return 0!=this._timer}start(t,e=16){let s=!1;if(this._timer)throw new Error("Cannot start loop twice.");this._timer=setInterval((()=>{s||(s=!0,t(),s=!1)}),e)}stop(){this._timer&&(clearInterval(this._timer),this._timer=0)}}class C{constructor(t){this._timers=[],this._ctx=t}get length(){return this._timers.length}clear(){this._timers=[]}restart(){this._timers.forEach((t=>{t.delay=t.repeat||0})),this._timers=this._timers.filter((t=>t.delay>0))}setTimeout(t,e){const s={fn:t,delay:e,repeat:0};return this._timers.push(s),()=>x(this._timers,s)}setInterval(t,e){const s={fn:t,delay:e,repeat:e};return this._timers.push(s),()=>x(this._timers,s)}update(t){if(!this._timers.length)return;let e=!1;this._timers.forEach((s=>{if(s.delay-=t,s.delay<=0){const t=s.fn.call(this._ctx);s.repeat&&!1!==t&&(s.delay+=s.repeat,s.delay<0&&(s.delay=s.repeat))}e=e||s.delay<=0})),e&&(this._timers=this._timers.filter((t=>t.delay>0)))}}class M{constructor(){this._tweens=[]}get length(){return this._tweens.length}clear(){this._tweens=[]}add(t){this._tweens.push(t)}remove(t){x(this._tweens,t)}update(t){this._tweens.forEach((e=>e.update(t))),this._tweens=this._tweens.filter((t=>t.isRunning()))}}class A{constructor(t){this.priority=0,(t.startsWith(":")||t.startsWith("."))&&(t="*"+t),this.text=t,this.matchFn=this._parse(t)}_parse(t){const e=t.split(/ +/g).map((t=>t.trim())),s=[];for(let t=0;t<e.length;++t){let i=e[t];">"===i?(s.push(this._parentMatch()),++t,i=e[t]):t>0&&s.push(this._ancestorMatch()),s.push(this._matchElement(i))}return s.reduce(((t,e)=>e.bind(void 0,t)),m)}_parentMatch(){return function(t,e){return!!e.parent&&t(e.parent)}}_ancestorMatch(){return function(t,e){let s=e.parent;for(;s;)if(t(s))return!0;return!1}}_matchElement(t){const e=[],s=new RegExp(/(?:(\w+|\*|\$)|#(\w+)|\.([^\.: ]+))|(?::(?:(?:not\(\.([^\)]+)\))|(?:not\(:([^\)]+)\))|([^\.: ]+)))/g,"g");let i=s.exec(t);for(;i;){if(i[1]){const t=this._matchTag(i[1]);t&&e.push(t)}else i[2]?e.push(this._matchId(i[2])):i[3]?e.push(this._matchClass(i[3])):i[4]?e.push(this._matchNot(this._matchClass(i[4]))):i[5]?e.push(this._matchNot(this._matchProp(i[5]))):e.push(this._matchProp(i[6]));i=s.exec(t)}return(t,s)=>!!e.every((t=>t(s)))&&t(s)}_matchTag(t){return"*"===t?null:"$"===t?(this.priority+=1e4,null):(this.priority+=10,e=>e.tag===t)}_matchClass(t){return this.priority+=100,e=>e.classes.includes(t)}_matchProp(t){return t.startsWith("first")?this._matchFirst():t.startsWith("last")?this._matchLast():"invalid"===t?this._matchNot(this._matchProp("valid")):"optional"===t?this._matchNot(this._matchProp("required")):"enabled"===t?this._matchNot(this._matchProp("disabled")):"unchecked"===t?this._matchNot(this._matchProp("checked")):(this.priority+=2,["odd","even"].includes(t)&&(this.priority-=1),e=>!!e.prop(t))}_matchId(t){return this.priority+=1e3,e=>e.attr("id")===t}_matchFirst(){return this.priority+=1,t=>!!t.parent&&!!t.parent.children&&t.parent.children[0]===t}_matchLast(){return this.priority+=1,t=>!!t.parent&&(!!t.parent.children&&t.parent.children[t.parent.children.length-1]===t)}_matchNot(t){return e=>!t(e)}matches(t){return this.matchFn(t)}}function R(t){if(Array.isArray(t))return t[0];if("object"!=typeof t)throw new Error("Not an XY or Loc.");return t.x||0}function I(t){if(Array.isArray(t))return t[1];if("object"!=typeof t)throw new Error("Not an XY or Loc.");return t.y||0}class P{constructor(t=0,e=0,s=0,i=0){if("number"!=typeof t){const h=t;i=h.height||0,s=h.width||0,e=h.y||0,t=h.x||0}this.x=t,this.y=e,this.width=s,this.height=i}get left(){return this.x}set left(t){this.x=t}get right(){return this.x+this.width}set right(t){this.x=t-this.width}get top(){return this.y}set top(t){this.y=t}get bottom(){return this.y+this.height}set bottom(t){this.y=t-this.height}get center(){return this.x+Math.floor(this.width/2)}set center(t){this.x+=t-this.center}get middle(){return this.y+Math.floor(this.height/2)}set middle(t){this.y+=t-this.middle}clone(){return new P(this.x,this.y,this.width,this.height)}copy(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height}contains(...t){let e=t[0],s=t[1];return"number"!=typeof e&&(s=I(e),e=R(e)),this.x<=e&&this.y<=s&&this.x+this.width>e&&this.y+this.height>s}expandToInclude(t){const e=Math.min(R(t),this.x),s=Math.min(I(t),this.y),i=Math.max(t instanceof P?t.right:e,this.right),h=Math.max(t instanceof P?t.bottom:s,this.bottom);this.left=e,this.top=s,this.width=i-e,this.height=h-s}pad(t=1){this.x-=t,this.y-=t,this.width+=2*t,this.height+=2*t}forEach(t){!function(...t){let e=0,s=0;arguments.length>3&&(e=t.shift(),s=t.shift());const i=e+t[0],h=s+t[1],n=t[2];for(let t=e;t<i;++t)for(let e=s;e<h;++e)n(t,e)}(this.x,this.y,this.width,this.height,t)}toString(){return`[${this.x},${this.y} -> ${this.right},${this.bottom}]`}getInternalXY(...t){let e=t[0],s=t[1];return"number"!=typeof e&&(s=I(e),e=R(e)),{x:e-this.x,y:s-this.y}}getExternalXY(...t){let e=t[0],s=t[1];return"number"!=typeof e&&(s=I(e),e=R(e)),{x:e+this.x,y:s+this.y}}}const O={make:function(t){t=Math.abs(t||Date.now());const e=2.3283064365386963e-10;let s=0,i=0,h=0,n=0;return s=((t=t<1?1/t:t)>>>0)*e,i=(t=69069*t+1>>>0)*e,h=(t=69069*t+1>>>0)*e,n=1,function(){let t=2091639*s+n*e;return s=i,i=h,n=0|t,h=t-n,h}}};function D(t,e){let s,i,h;for(i=0,s=0;s<e.length;s++)i+=e[s];if(i<=0)return-1;for(h=t.range(0,i-1),s=0;s<e.length;s++){if(e[s]>h)return s;h-=e[s]}return console.warn("Lottery Draw failed.",e,e.length),0}class F{constructor(t){this._fn=O.make(t)}seed(t){t=t||Date.now(),this._fn=O.make(t)}value(){return this._fn()}float(){return this.value()}int(t=Number.MAX_SAFE_INTEGER){return t<=0?0:Math.floor(this.value()*t)}range(t,e){if(e<=t)return e;const s=e-t+1;return t+this.int(s)}normal(t=0,e=1){let s,i,h;do{s=2*this.value()-1,i=2*this.value()-1,h=s*s+i*i}while(h>1||0==h);return t+s*Math.sqrt(-2*Math.log(h)/h)*e}dice(t,e,s=0){let i=0,h=1;t<0&&(t=-t,h=-1),s=s||0;for(let s=0;s<t;++s)i+=this.range(1,e);return i*=h,i+s}weighted(t){return Array.isArray(t)?D(this,t):function(t,e){const s=Object.entries(e),i=D(t,s.map((([t,e])=>e)));return i<0?-1:s[i][0]}(this,t)}item(t){return Array.isArray(t)||(t=Object.values(t)),t[this.range(0,t.length-1)]}key(t){return this.item(Object.keys(t))}shuffle(t,e=0,s=0){let i,h,n;for(2==arguments.length&&(s=e,e=0),s=s||t.length,i=e=e||0;i<s;i++)h=this.range(e,s-1),i!=h&&(n=t[h],t[h]=t[i],t[i]=n);return t}sequence(t){const e=[];for(let s=0;s<t;s++)e[s]=s;return this.shuffle(e)}chance(t,e=100){return!(t<=0)&&(t>=e||this.int(e)<t)}clumped(t,e,s){if(e<=t)return t;if(s<=1)return this.range(t,e);let i,h=0,n=Math.floor((e-t)/s);for(i=0;i<(e-t)%s;i++)h+=this.range(0,n+1);for(;i<s;i++)h+=this.range(0,n);return h+t}}const N=new F,B=new F,W={};class j{constructor(t=-1,e=0,s=0,i=100){this._rand=null,this.dances=!1,t<0&&(i=0,t=0),this._data=[t,e,s,i]}rgb(){return[this.r255,this.g255,this.b255]}rgba(){return[this.r255,this.g255,this.b255,this.a]}get r255(){return Math.round(2.550001*this._data[0])}get r(){return this._data[0]}get ra(){return Math.round(this._data[0]*this._data[3]/100)}get g255(){return Math.round(2.550001*this._data[1])}get g(){return this._data[1]}get ga(){return Math.round(this._data[1]*this._data[3]/100)}get b255(){return Math.round(2.550001*this._data[2])}get b(){return this._data[2]}get ba(){return Math.round(this._data[2]*this._data[3]/100)}get a255(){return Math.round(2.550001*this._data[3])}get a(){return this._data[3]}rand(t,e=0,s=0,i=0){return this._rand=[t,e,s,i],this.dances=!1,this}dance(t,e,s,i){return this.rand(t,e,s,i),this.dances=!0,this}isNull(){return 0===this._data[3]}alpha(t){return new j(this._data[0],this._data[1],this._data[2],w(t,0,100))}get l(){return Math.round(.5*(Math.min(this.r,this.g,this.b)+Math.max(this.r,this.g,this.b)))}get s(){return this.l>=100?0:Math.round((Math.max(this.r,this.g,this.b)-Math.min(this.r,this.g,this.b))*(100-Math.abs(2*this.l-100))/100)}get h(){let t=0,e=this.r255,s=this.g255,i=this.b255;return t=e>=s&&s>=i?(s-i)/(e-i)*60:s>e&&e>=i?60*(2-(e-i)/(s-i)):s>=i&&i>e?60*(2+(i-e)/(s-e)):i>s&&s>e?60*(4-(s-e)/(i-e)):i>e&&e>=s?60*(4+(e-s)/(i-s)):60*(6-(i-s)/(e-s)),Math.round(t)||0}equals(t){if("string"==typeof t){if(t.startsWith("#"))return(t=H(t)).equals(this);if(this.name)return this.name===t}else if("number"==typeof t)return this.toInt()===t;const e=H(t);return this.isNull()?e.isNull():!e.isNull()&&this.toInt()===e.toInt()}toInt(t=!0){if(this.isNull())return 0;let e=this.r,s=this.g,i=this.b,h=this.a;if(t&&(this._rand||this.dances)){const t=B.int(this._rand[0]),n=B.int(this._rand[1]),r=B.int(this._rand[2]),a=B.int(this._rand[3]);e=Math.round((e+t+n)*h/100),s=Math.round((s+t+r)*h/100),i=Math.round((i+t+a)*h/100)}return e=Math.max(0,Math.min(15,Math.round(e/100*15))),s=Math.max(0,Math.min(15,Math.round(s/100*15))),i=Math.max(0,Math.min(15,Math.round(i/100*15))),h=Math.max(0,Math.min(15,Math.round(h/100*15))),(e<<12)+(s<<8)+(i<<4)+h}toLight(){return[this.ra,this.ga,this.ba]}clamp(){return this.isNull()?this:Y(this._data.map((t=>w(t,0,100))))}blend(t){const e=H(t);return this.mix(e,e.a)}mix(t,e){const s=H(t);if(s.isNull())return this;if(e>=100)return s;const i=w(e,0,100)/100,h=1-i,n=Y(Math.round(this._data[0]*h+s._data[0]*i),Math.round(this._data[1]*h+s._data[1]*i),Math.round(this._data[2]*h+s._data[2]*i),(this.isNull()?100:this._data[3])*h+s._data[3]*i);if(this._rand&&(n._rand=this._rand.slice(),n.dances=this.dances),s._rand){n._rand||(n._rand=[0,0,0,0]);for(let t=0;t<4;++t)n._rand[t]=Math.round(n._rand[t]*h+s._rand[t]*i);n.dances=n.dances||s.dances}return n}apply(t){const e=H(t);if(e.isNull())return this;if(e.a>=100)return e;if(e.a<=0)return this;const s=w(e.a,0,100)/100,i=(1-s)*this.a/100,h=Y(Math.round(this._data[0]*i+e._data[0]*s),Math.round(this._data[1]*i+e._data[1]*s),Math.round(this._data[2]*i+e._data[2]*s),Math.round(this._data[3]*i+e._data[3]*s));if(this._rand&&(h._rand=this._rand.slice(),h.dances=this.dances),e._rand){if(h._rand)for(let t=0;t<4;++t)h._rand[t]=Math.round(h._rand[t]*i+e._rand[t]*s);else h._rand=e._rand.map((t=>Math.round(t*s)));h.dances=h.dances||e.dances}return h}lighten(t){if(this.isNull())return this;if(t<=0)return this;const e=w(t,0,100)/100,s=1-e;return Y(Math.round(this._data[0]*s+100*e),Math.round(this._data[1]*s+100*e),Math.round(this._data[2]*s+100*e),this.a)}darken(t){if(this.isNull())return this;const e=w(t,0,100)/100,s=1-e;return Y(Math.round(this._data[0]*s+0*e),Math.round(this._data[1]*s+0*e),Math.round(this._data[2]*s+0*e),this.a)}bake(t=!1){if(this.isNull())return this;if(!this._rand)return this;if(this.dances&&!t)return this;const e=this._rand,s=B.int(e[0]),i=B.int(e[1]),h=B.int(e[2]),n=B.int(e[3]);return Y(this.r+s+i,this.g+s+h,this.b+s+n,this.a)}add(t,e=100){const s=H(t);if(s.isNull())return this;const i=s.a/100*(e/100);return Y(Math.round(this._data[0]+s._data[0]*i),Math.round(this._data[1]+s._data[1]*i),Math.round(this._data[2]+s._data[2]*i),w(Math.round(this.a+100*i),0,100))}scale(t){if(this.isNull()||100==t)return this;const e=Math.max(0,t)/100;return Y(Math.round(this._data[0]*e),Math.round(this._data[1]*e),Math.round(this._data[2]*e),this.a)}multiply(t){if(this.isNull())return this;let e;if(Array.isArray(t)){if(t.length<3)throw new Error("requires at least r,g,b values.");e=t}else{if(t.isNull())return this;e=t._data}const s=(e[3]||100)/100;return Y(Math.round(this.ra*(e[0]/100)*s),Math.round(this.ga*(e[1]/100)*s),Math.round(this.ba*(e[2]/100)*s),100)}normalize(){if(this.isNull())return this;const t=Math.max(this.ra,this.ga,this.ba);return t<=100?this:Y(Math.round(100*this.ra/t),Math.round(100*this.ga/t),Math.round(100*this.ba/t),100)}inverse(){return new j(100-this.r,100-this.g,100-this.b,this.a)}css(t=!0){if(100!==this.a){const e=this.toInt(t);return e<=0?"transparent":"#"+e.toString(16).padStart(4,"0")}const e=this.toInt(t);return e<=0?"transparent":"#"+e.toString(16).padStart(4,"0").substring(0,3)}toString(){return this.name?this.name:this.isNull()?"transparent":this.css()}}function L(t){const e=W[t];if(!e)throw new Error("Unknown color name: "+t);return e}function U(t,e=!1){return t<0?new j:e||t>4095?new j(Math.round(100*((16711680&t)>>16)/255),Math.round(100*((65280&t)>>8)/255),Math.round(100*(255&t)/255),100):new j(Math.round(100*((3840&t)>>8)/15),Math.round(100*((240&t)>>4)/15),Math.round(100*(15&t)/15),100)}function Y(...t){let e=t[0],s=t[1];if(0==t.length)return new j;if(t.length>2&&(e=t,s=!1),null==e)return new j;if(e instanceof j)return e;if("string"==typeof e)return e.startsWith("#")?function(t){if(!t.startsWith("#"))throw new Error('Color CSS strings must be of form "#abc" or "#abcdef" - received: ['+t+"]");const e=Number.parseInt(t.substring(1),16);let s,i,h,n=100;return 4==t.length?(s=Math.round((e>>8)/15*100),i=Math.round(((240&e)>>4)/15*100),h=Math.round((15&e)/15*100)):5==t.length?(s=Math.round((e>>12)/15*100),i=Math.round(((3840&e)>>8)/15*100),h=Math.round(((240&e)>>4)/15*100),n=Math.round((15&e)/15*100)):7===t.length?(s=Math.round((e>>16)/255*100),i=Math.round(((65280&e)>>8)/255*100),h=Math.round((255&e)/255*100)):9===t.length&&(s=Math.round((e>>24)/255*100),i=Math.round(((16711680&e)>>16)/255*100),h=Math.round(((65280&e)>>8)/255*100),n=Math.round((255&e)/255*100)),new j(s,i,h,n)}(e):L(e);if(Array.isArray(e))return function(t,e=!1){for(;t.length<3;)t.push(0);if(e)for(let e=0;e<3;++e)t[e]=Math.round(100*(t[e]||0)/255);return new j(...t)}(e,s);if("number"==typeof e)return U(e,s);throw new Error("Failed to make color - unknown argument: "+JSON.stringify(e))}function H(...t){const e=t[0];if(e instanceof j)return e;if(void 0===e)return q;if(null===e)return q;if("string"==typeof e){if(!e.startsWith("#"))return L(e)}else if(-1===e)return q;return Y(e,t[1])}function X(t,...e){let s=e;1==e.length&&(s=e[0]);const i=s instanceof j?s:Y(s);return i._const=!0,W[t]=i,i.name=t,i}function K(t,e){const s=X(t,e);return X("light_"+t,s.lighten(25)),X("lighter_"+t,s.lighten(50)),X("lightest_"+t,s.lighten(75)),X("dark_"+t,s.darken(25)),X("darker_"+t,s.darken(50)),X("darkest_"+t,s.darken(75)),s}const q=X("NONE",-1),G=X("black",0),z=X("white",4095);K("teal",[30,100,100]),K("brown",[60,40,0]),K("tan",[80,70,55]),K("pink",[100,60,66]),K("gray",[50,50,50]),K("grey",[50,50,50]),K("yellow",[100,100,0]),K("purple",[100,0,100]),K("green",[0,100,0]),K("orange",[100,50,0]),K("blue",[0,0,100]),K("red",[100,0,0]),K("amber",[100,75,0]),K("flame",[100,25,0]),K("fuchsia",[100,0,100]),K("magenta",[100,0,75]),K("crimson",[100,0,25]),K("lime",[75,100,0]),K("chartreuse",[50,100,0]),K("sepia",[50,40,25]),K("violet",[50,0,100]),K("han",[25,0,100]),K("cyan",[0,100,100]),K("turquoise",[0,100,75]),K("sea",[0,100,50]),K("sky",[0,75,100]),K("azure",[0,50,100]),K("silver",[75,75,75]),K("gold",[100,85,0]);class ${constructor(t="$",e){this._dirty=!1,this.selector=new A(t),e&&this.set(e),this._dirty=!1}get dirty(){return this._dirty}set dirty(t){this._dirty=t}get fg(){return this._fg}get bg(){return this._bg}get opacity(){return this._opacity}dim(t=25,e=!0,s=!1){return e&&(this._fg=H(this._fg).darken(t)),s&&(this._bg=H(this._bg).darken(t)),this}bright(t=25,e=!0,s=!1){return e&&(this._fg=H(this._fg).lighten(t)),s&&(this._bg=H(this._bg).lighten(t)),this}invert(){return[this._fg,this._bg]=[this._bg,this._fg],this}get align(){return this._align}get valign(){return this._valign}get(t){return this["_"+t]}set(t,e,s=!0){if("string"==typeof t){const s="_"+t;"string"==typeof e&&(e.match(/^[+-]?\d+$/)?e=Number.parseInt(e):"true"===e?e=!0:"false"===e&&(e=!1)),this[s]=e}else t instanceof $?(s=!(!e&&void 0!==e),Object.entries(t).forEach((([t,e])=>{"selector"!==t&&"_dirty"!==t&&(null!=e?this[t]=e:null===e&&this.unset(t))}))):(s=!(!e&&void 0!==e),Object.entries(t).forEach((([t,e])=>{null===e?this.unset(t):this.set(t,e,s)})));return this.dirty||=s,this}unset(t){return delete this[t.startsWith("_")?t:"_"+t],this.dirty=!0,this}clone(){const t=new this.constructor;return t.copy(this),t}copy(t){return Object.assign(this,t),this}}class V extends ${constructor(t){super(),this.sources=[],this._baseFg=null,this._baseBg=null,t&&(t.sort(((t,e)=>t.selector.priority-e.selector.priority)),this.sources=t),this.sources.forEach((t=>super.set(t))),this._dirty=!1}get opacity(){return this._opacity??100}set opacity(t){if(t=w(t,0,100),this._opacity=t,100===t)return this._fg=this._baseFg||this._fg,void(this._bg=this._baseBg||this._bg);void 0!==this._fg&&(this._baseFg=this._baseFg||H(this._fg),this._fg=this._baseFg.alpha(t)),void 0!==this._bg&&(this._baseBg=this._baseBg||H(this._bg),this._bg=this._baseBg.alpha(t))}get dirty(){return this._dirty||this.sources.some((t=>t.dirty))}set dirty(t){this._dirty=t}}class Q{constructor(t){this.rules=[],this._dirty=!0,this._parent=t||null}get dirty(){return this._dirty}set dirty(t){this._dirty=t,this._dirty||this.rules.forEach((t=>t.dirty=!1))}setParent(t){this._parent=t}add(t,e){if(t.includes(","))return t.split(",").map((t=>t.trim())).forEach((t=>this.add(t,e))),this;if(t.includes(" "))throw new Error("Hierarchical selectors not supported.");let s=new $(t,e);return this.rules.push(s),this.dirty=!0,this}get(t){return this.rules.find((e=>e.selector.text===t))||null}load(t){return Object.entries(t).forEach((([t,e])=>{this.add(t,e)})),this}remove(t){const e=this.rules.findIndex((e=>e.selector.text===t));e>-1&&(this.rules.splice(e,1),this.dirty=!0)}_rulesFor(t){let e=this.rules.filter((e=>e.selector.matches(t)));return this._parent&&(e=this._parent._rulesFor(t).concat(e)),e}computeFor(t){const e=this._rulesFor(t),s=t.style();return s&&(e.push(s),s.dirty=!1),new V(e)}}const J=new Q(null);J.add("*",{fg:"white"});class Z{constructor(t={}){if(this.parent=null,this.scene=null,this.children=[],this.events=new T(this),this._style=new $,this._data={},this.classes=[],this._props={needsDraw:!0,needsStyle:!0,hover:!1},this._attrs={},t.id&&this.attr("id",t.id),this.attr("tag",t.tag||"widget"),this.bounds=new P(t),this._style.set(t),t.class&&(this.classes=t.class.split(/ +/g).map((t=>t.trim()))),t.tabStop&&this.prop("tabStop",!0),t.disabled&&this.prop("disabled",!0),t.hidden&&(this.hidden=!0),t.data&&(this._data=t.data),t.action=t.action||t.id,t.action){if(!0===t.action){if(!t.id)throw new Error("boolean action requires id.");t.action=t.id}this.attr("action",t.action)}["create","input","update","draw","destroy","keypress","mouseenter","mousemove","mouseleave","click"].forEach((e=>{e in t&&this.on(e,t[e])})),t.on&&Object.entries(t.on).forEach((([t,e])=>this.on(t,e))),t.parent?this.setParent(t.parent,t):t.scene&&t.scene.addChild(this,t)}get needsDraw(){return!!this.scene&&this.scene.needsDraw}set needsDraw(t){t&&this.scene&&(this.scene.needsDraw=t)}get tag(){return this._attrStr("tag")}get id(){return this._attrStr("id")}data(...t){if(0==t.length)return this._data;if(2==t.length)return this._setDataItem(t[0],t[1]),this.needsDraw=!0,this;if("string"==typeof t[0]){if(Array.isArray(this._data))throw new Error("Cannot access fields of array data.");return this._data[t[0]]}return this._setData(t[0]),this.needsDraw=!0,this}_setData(t){this._data=t}_setDataItem(t,e){if(Array.isArray(this._data))throw new Error("Cannot set field in array data.");this._data[t]=e}pos(t,e){return void 0===t?this.bounds:("number"==typeof t?(this.bounds.x=t,this.bounds.y=e||0):(this.bounds.x=t.x,this.bounds.y=t.y),this.needsDraw=!0,this)}updatePos(t){(this.parent||this.scene)&&(t.centerX||t.center?this.centerX():t.left?this.left(t.left):t.right?this.right(t.right):t.x&&(this.bounds.x=t.x),t.centerY||t.center?this.centerY():t.top?this.top(t.top):t.bottom?this.bottom(t.bottom):t.y&&(this.bounds.y=t.y))}contains(...t){return!this.hidden&&(!!this.bounds.contains(t[0],t[1])||this.children.some((e=>e.contains(t[0],t[1]))))}center(t){return this.centerX(t).centerY(t)}centerX(t){const e=t||(this.parent?this.parent.bounds:this.scene);if(!e)throw new Error("Need parent or scene to apply center.");if("x"in e){const t=this.bounds.width,s=Math.round((e.width-t)/2);this.bounds.x=e.x+s}else this.bounds.x=Math.round((e.width-this.bounds.width)/2);return this}centerY(t){const e=t||(this.parent?this.parent.bounds:this.scene);if(!e)throw new Error("Need parent or scene to apply center.");if("y"in e){const t=this.bounds.height,s=Math.round((e.height-t)/2);this.bounds.y=e.y+s}else this.bounds.y=Math.round((e.height-this.bounds.height)/2);return this}left(t){const e=this.parent?this.parent.bounds.left:0;return this.bounds.left=e+t,this}right(t){return this.parent?this.bounds.right=this.parent.bounds.right+t:this.scene?this.bounds.right=this.scene.width+t-1:this.bounds.left=0,this}top(t){const e=this.parent?this.parent.bounds.top:0;return this.bounds.top=e+t,this}bottom(t){return this.parent?this.bounds.bottom=this.parent.bounds.bottom+t-1:this.scene?this.bounds.bottom=this.scene.height+t-1:this.bounds.top=0,this}resize(t,e){return this.bounds.width=t||this.bounds.width,this.bounds.height=e||this.bounds.height,this.needsDraw=!0,this}style(...t){if(0==t.length)return this._style;if("string"!=typeof t[0])this._style.set(t[0]);else{if(void 0===t[1]){return(this._used||this._style).get(t[0])}this._style.set(t[0],t[1])}return this.needsStyle=!0,this}addClass(t){return t.split(/ +/g).forEach((t=>{this.classes.includes(t)||this.classes.push(t)})),this}removeClass(t){return t.split(/ +/g).forEach((t=>{x(this.classes,t)})),this}hasClass(t){const e=t.split(/ +/g);return s=this.classes,e.every((t=>s.includes(t)));var s}toggleClass(t){return t.split(/ +/g).forEach((t=>{this.classes.includes(t)?x(this.classes,t):this.classes.push(t)})),this}attr(t,e){return void 0===e?this._attrs[t]:(this._attrs[t]=e,this)}_attrInt(t){const e=this._attrs[t]||0;return"number"==typeof e?e:"string"==typeof e?Number.parseInt(e):e?1:0}_attrStr(t){const e=this._attrs[t]||"";return"string"==typeof e?e:"number"==typeof e?""+e:e?"true":"false"}_attrBool(t){return!!this._attrs[t]}text(t){return void 0===t?this._attrStr("text"):(this.attr("text",t),this)}prop(t,e){if(void 0===e)return this._props[t];return this._props[t]!==e&&this._setProp(t,e),this}_setProp(t,e){this._props[t]=e,this.needsStyle=!0}_propInt(t){const e=this._props[t]||0;return"number"==typeof e?e:"string"==typeof e?Number.parseInt(e):e?1:0}_propStr(t){const e=this._props[t]||"";return"string"==typeof e?e:"number"==typeof e?""+e:e?"true":"false"}_propBool(t){return!!this._props[t]}toggleProp(t){const e=!!this._props[t];return this.prop(t,!e),this}incProp(t,e=1){let s=this.prop(t)||0;return"boolean"==typeof s?s=s?1:0:"string"==typeof s&&(s=Number.parseInt(s)||0),s+=e,this.prop(t,s),this}get hovered(){return!!this.prop("hover")}set hovered(t){this.prop("hover",t)}get disabled(){let t=this;for(;t;){if(t.prop("disabled"))return!0;t=t.parent}return!1}set disabled(t){this.prop("disabled",t)}get hidden(){let t=this;for(;t;){if(t.prop("hidden"))return!0;t=t.parent}return!1}set hidden(t){this.prop("hidden",t),!t&&this._used&&0==this._used.opacity&&(this._used.opacity=100),t&&this.scene&&this.scene.focused===this?this.scene.nextTabStop():!t&&this.scene&&null===this.scene.focused&&this.scene.setFocusWidget(this),this.emit(t?"hide":"show")}get needsStyle(){return this._propBool("needsStyle")}set needsStyle(t){this._props.needsStyle=t,t&&(this.needsDraw=!0)}get focused(){return!!this.prop("focus")}focus(t=!1){this.prop("focus")||(this.prop("focus",!0),this.emit("focus",{reverse:t}))}blur(t=!1){this.prop("focus")&&(this.prop("focus",!1),this.emit("blur",{reverse:t}))}setParent(t,e){if(this.parent!==t){if(this.parent){const t=this.parent.children.indexOf(this);if(t<0)throw new Error("Error in parent/child setup!");this.parent.children.splice(t,1)}if(t){if(this.scene!==t.scene&&(this.scene&&this.scene._detach(this),t.scene&&t.scene._attach(this),e&&e.focused&&this.scene.setFocusWidget(this)),e&&e.first)t.children.unshift(this);else if(e&&e.before){let s=-1;s="string"==typeof e.before?t.children.findIndex((t=>t.id===e.before)):t.children.indexOf(e.before),s<0?t.children.unshift(this):t.children.splice(s,0,this)}else if(e&&e.after){let s=-1;s="string"==typeof e.after?t.children.findIndex((t=>t.id===e.before)):t.children.indexOf(e.after),s<0?t.children.push(this):t.children.splice(s+1,0,this)}else t.children.push(this);this.parent=t}else this.scene&&this.scene._detach(this),this.parent=null;e&&(this.parent||this.scene)&&this.updatePos(e)}}addChild(t){this.children.includes(t)||t.setParent(this)}removeChild(t){this.children.includes(t)&&t.setParent(null)}childAt(t,e){var s;(s=t)&&"number"==typeof s.x&&"number"==typeof s.y||(t={x:t,y:e});for(let e of this.children)if(e.contains(t))return e;return null}getChild(t){return this.children.find((e=>e.id===t))||null}on(t,e){return"keypress"===t&&this.prop("tabStop",!0),this.events.on(t,e)}once(t,e){return"keypress"===t&&this.prop("tabStop",!0),this.events.once(t,e)}off(t,e){this.events.off(t,e)}emit(t,...e){return this.events.emit(t,...e)}action(t){if(t&&t.defaultPrevented)return;this.emit("action")&&t?.stopPropagation();const e=this._attrStr("action");e&&e.length&&this.scene&&this.scene.emit(e,this)&&t?.stopPropagation()}input(t){this.emit("input",t),t.defaultPrevented||t.propagationStopped||(t.type===i?this.keypress(t):t.type===h?this.mousemove(t):t.type===n&&this.click(t))}_mouseenter(t){this.bounds.contains(t)&&(this.hovered||(this.hovered=!0,this.emit("mouseenter",t)))}mousemove(t){for(let e of this.children)e.mousemove(t);this.bounds.contains(t)&&!this.hidden?(this._mouseenter(t),this._mousemove(t)):this._mouseleave(t)}_mousemove(t){this.emit("mousemove",t)}_mouseleave(t){this.hovered&&(this.bounds.contains(t)||(this.hovered=!1,this.emit("mouseleave",t)))}click(t){if(this.disabled||this.hidden)return;t.target=this;const e=this.childAt(t);e&&e.click(t),this.bounds.contains(t)&&(t.propagationStopped||(this._click(t),t.defaultPrevented||this.action(t)))}_click(t){this.events.emit("click",t)}keypress(t){if(this.hidden||this.disabled)return;let e=this;for(;e&&!t.propagationStopped;)t.dispatch(e.events),e=e.parent}draw(t){this.needsStyle&&this.scene&&(this._used=this.scene.styles.computeFor(this),this.needsStyle=!1),this.hidden||(this._draw(t),this.emit("draw",t),this.children.forEach((e=>e.draw(t))))}_draw(t){this._drawFill(t)}_drawFill(t){const e=this.bounds;t.fillRect(e.x,e.y,e.width,e.height," ",this._used.bg,this._used.bg)}update(t){this.emit("update",t)}fixedUpdate(t){this.emit("fixedUpdate",t)}destroy(){this.parent&&this.setParent(null),this.scene&&this.scene._detach(this),this.children.forEach((t=>t.destroy())),this.children=[],this._used=null}}function tt(t,e="left"){if(!(t.children.length<2))if("left"===e){const e=t.children.reduce(((t,e)=>Math.min(t,e.bounds.left)),999);t.children.forEach((t=>t.bounds.left=e))}else if("right"===e){const e=t.children.reduce(((t,e)=>Math.max(t,e.bounds.right)),0);t.children.forEach((t=>t.bounds.right=e))}else{const e=t.children.reduce(((t,e)=>Math.max(t,e.bounds.right)),0),s=t.children.reduce(((t,e)=>Math.min(t,e.bounds.left)),999),i=s+Math.floor((e-s)/2);t.children.forEach((t=>{t.bounds.center=i}))}}function et(t,e=0){if(t.children.length<2)return;let s=t.children.reduce(((t,e)=>Math.min(t,e.bounds.top)),999);t.children.slice().sort(((t,e)=>t.bounds.top-e.bounds.top)).forEach((t=>{t.bounds.top=s,s=t.bounds.bottom+e}))}function st(t,e=0){t.children.length<1||(t.bounds.copy(t.children[0].bounds),t.children.forEach((e=>{t.bounds.expandToInclude(e.bounds)})),t.bounds.pad(e))}class it{constructor(){this.events=new T(this),this.children=[]}on(t,e){return this.events.on(t,e),this}once(t,e){return this.events.once(t,e),this}off(t,e){return this.events.off(t,e),this}emit(t,...e){return this.events.emit(t,...e)}addChild(t){return this.children.push(t),this}removeChild(t){return x(this.children,t),this}update(t){this.children.forEach((e=>e.update(t))),this.emit("update",t)}}class ht extends it{constructor(t){super(),this._repeat=0,this._count=0,this._from=!1,this._duration=0,this._delay=0,this._repeatDelay=-1,this._yoyo=!1,this._time=Number.MAX_SAFE_INTEGER,this._startTime=0,this._goal={},this._start={},this._success=!0,this._easing=at,this._interpolate=ot,this._obj=t}isRunning(){return this._startTime>0||this._time<this._duration||this.children.length>0}onStart(t){return this.on("start",t),this}onUpdate(t){return this.on("update",t),this}onRepeat(t){return this.on("repeat",t),this}onFinish(t){return this.on("stop",t),this}to(t,e){return e?("boolean"==typeof e&&(e=Object.keys(t)),this._goal={},e.forEach((e=>{this._goal[e]=()=>t[e]}))):this._goal=t,0==Object.keys(this._start).length&&Object.keys(this._goal).forEach((t=>{this._start[t]=this._obj[t]})),this}from(t,e){return e?("boolean"==typeof e&&(e=Object.keys(t)),this._start={},e.forEach((e=>{this._start[e]=()=>t[e]}))):this._start=t,0==Object.keys(this._goal).length&&Object.keys(this._start).forEach((t=>{this._goal[t]=this._obj[t]})),this}duration(t){return void 0===t?this._duration:(this._duration=t,this)}repeat(t){return void 0===t?this._repeat:(this._repeat=t,this)}delay(t){return void 0===t?this._delay:(this._delay=t,this)}repeatDelay(t){return void 0===t?this._repeatDelay:(this._repeatDelay=t,this)}yoyo(t){return void 0===t?this._yoyo:(this._yoyo=t,this)}start(t){return this._success=!0,this._time>0&&(this._time=0,this._startTime=this._delay,this._count=0,this._updateProperties(this._obj,this._start,this._goal,0)),t&&t.add(this),this}update(t){if(!this.isRunning())return;if(this.children.forEach((e=>e.update(t))),this.children=this.children.filter((t=>t.isRunning())),this._time+=t,this._startTime){if(this._startTime>this._time)return;this._time-=this._startTime,this._startTime=0,this._count>0&&this._restart()}0===this._count&&this._restart();const e=this._easing(this._time/this._duration);this._updateProperties(this._obj,this._start,this._goal,e)&&this.emit("update",this._obj,e),this._time>=this._duration&&(this._repeat>this._count||this._repeat<0?(this._time=this._time%this._duration,this._startTime=this._repeatDelay>-1?this._repeatDelay:this._delay,this._yoyo&&([this._start,this._goal]=[this._goal,this._start]),this._startTime||this._restart()):this.isRunning()||this.emit("stop",this._obj,this._success))}_restart(){++this._count,this._updateProperties(this._obj,this._start,this._goal,0),1==this._count?this.emit("start",this._obj,0):this.emit("repeat",this._obj,this._count)||this.emit("update",this._obj,0)}stop(t=!1){this._success=t,this._time=Number.MAX_SAFE_INTEGER,this.children.forEach((e=>e.stop(t)))}_updateProperties(t,e,s,i){let h=!1;return Object.entries(s).forEach((([s,n])=>{let r=t[s],a=e[s];"function"==typeof a&&(a=a.call(e)),"function"==typeof n&&(n=n.call(t));const o=this._interpolate(a,n,i);o!==r&&(t[s]=o,h=!0)})),h}}function nt(t,e=1e3){return new ht(t).duration(e)}const rt=nt;function at(t){return w(t,0,1)}function ot(t,e,s){return"number"!=typeof t||"number"!=typeof e?0==Math.floor(s)?t:e:Math.round((e-t)*s)+t}class dt{constructor(t={}){this.ch=function(...t){return t.find((t=>void 0!==t))}(t.ch,null),this.fg=Y(t.fg),this.bg=Y(t.bg)}get opacity(){return 100}_changed(){return this}copy(t){return this.ch=t.ch||null,this.fg=t.fg,this.bg=t.bg,this._changed()}fill(t,e,s){return null!==t&&(this.ch=t),null!==e&&(this.fg=H(e)),null!==s&&(this.bg=H(s)),this._changed()}clone(){const t=new dt;return t.copy(this),t}equals(t){return this.ch==t.ch&&this.fg.equals(t.fg||null)&&this.bg.equals(t.bg||null)}get dances(){return this.fg.dances||this.bg.dances}nullify(){return this.ch=null,this.fg=q,this.bg=q,this._changed()}blackOut(){return this.ch=null,this.fg=G,this.bg=G,this._changed()}draw(t=null,e=null,s=null){return null!==t&&-1!==t&&(this.ch=t),null!==e&&(e=H(e),this.fg=this.fg.blend(e)),null!==s&&(s=H(s),this.bg=this.bg.blend(s)),this._changed()}drawSprite(t){if(t===this)return this;if(t.fg&&-1!==t.fg){const e=H(t.fg);t.ch&&e.a&&(this.ch=t.ch),this.fg=this.fg.apply(e)}if(null!==t.bg&&-1!==t.bg){const e=H(t.bg);this.bg=this.bg.apply(e)}return this._changed()}mixSprite(t,e){if(t===this)return this;if(void 0===e&&(e=t.opacity),void 0===e&&(e=100),e<=0)return;const s=H(t.fg),i=H(t.bg);return s.isNull()||t.ch&&(this.ch=t.ch),this.mix(s,e,0),this.mix(i,0,e),this._changed()}invert(){return this.bg=this.bg.inverse(),this.fg=this.fg.inverse(),this._changed()}swap(){return[this.bg,this.fg]=[this.fg,this.bg],this._changed()}multiply(t,e=!0,s=!0){return t=H(t),e&&(this.fg=this.fg.multiply(t)),s&&(this.bg=this.bg.multiply(t)),this._changed()}scale(t,e=!0,s=!0){return e&&(this.fg=this.fg.scale(t)),s&&(this.bg=this.bg.scale(t)),this._changed()}mix(t,e=50,s=e){return t=H(t),e>0&&(this.fg=this.fg.mix(t,e)),s>0&&(this.bg=this.bg.mix(t,s)),this._changed()}add(t,e=100,s=e){return t=H(t),e>0&&(this.fg=this.fg.add(t,e)),s>0&&(this.bg=this.bg.add(t,s)),this._changed()}separate(){return[this.fg,this.bg]=function(t,e){if(t.isNull()||e.isNull())return[t,e];const s=t.clamp(),i=e.clamp();let h=Math.abs(s.h-i.h);if(h>180&&(h=360-h),h>45)return[s,i];if(Math.abs(s.l-i.l)>=40)return[s,i];const n=[s,i],r=s.s<=i.s?0:1,a=1-r;for(;n[a].l-n[r].l<40;)n[a]=n[a].mix(z,5),n[r]=n[r].mix(G,5);return n}(this.fg,this.bg),this._changed()}bake(t=!1){return this.fg=this.fg.bake(t),this.bg=this.bg.bake(t),this._changed()}toString(){return`{ ch: ${this.ch}, fg: ${this.fg.toString()}, bg: ${this.bg.toString()} }`}}function lt(t){return!!t&&"object"==typeof t&&t.constructor===Object}function ut(t,e){const s=e.split(".");let i=t;for(;s.length>0;){i=i[s.shift()]}return i}function ct(t,e){let s=Object.assign({},t);if(!lt(t)||!lt(e))throw new Error("mergeDeep only works on plain objects, not classes.");return Object.keys(e).forEach((i=>{lt(e[i])?i in t?s[i]=ct(t[i],e[i]):Object.assign(s,{[i]:ct({},e[i])}):Object.assign(s,{[i]:e[i]})})),s}var ft={colorStart:"#{",colorEnd:"}",field:"{{",fieldEnd:"}}",defaultFg:null,defaultBg:null},pt={default:(t,e,s)=>0===s.length?t:1===s.length?""+ut(e,s[0]):s.map((t=>ut(e,t))).join(" "),debug:(t,e,s)=>s.length?`{{${t} ${s.join(" ")}}}`:`{{${t}}}`};function gt(t){if(!t||0==t.length)return 0;let e=0,s=!1,i=!1;for(let h=0;h<t.length;++h){const n=t.charAt(h);i?"}"===n?(i=!1,s=!1):e+=1:s?" "===n?i=!0:"}"===n&&(s=!1):"#"===n?"{"===t.charAt(h+1)?(s=!0,h+=1):e+=1:"\\"===n?("#"===t.charAt(h+1)&&(h+=1),e+=1):e+=1}return e}function _t(t,e,s=" "){const i=gt(t);if(i>=e)return t;const h=t.length-i;return t.padEnd(e+h,s)}function bt(t,e={}){const s=e.field||ft.field,i=function(t,e={}){const s=[];let i=!1,h=0,n=!1,r=0;for(;r<t.length;){const e=t.charAt(r);if(i){if("}"===e){if("}"!==t.charAt(r+1))throw new Error("Templates cannot contain }");const e=t.slice(h,r);s.push(e),++r,i=!1,h=r+1}}else if("\\"===e)"{"===t.charAt(r+1)&&(++r,n=!0);else if("{"===e&&"{"===t.charAt(r+1)){for(;"{"===t.charAt(r+1);)++r;i=!0;let e=t.slice(h,r-1);n&&(e=e.replace(/\\\{/g,"{")),s.push(e),h=r+1,n=!1}++r}if(h!==t.length){let e=t.slice(h);n&&(e=e.replace(/\\\{/g,"{")),s.push(e)}return s}(t),h=i.map(((t,i)=>i%2==0?mt(t):0==t.length?mt(s):function(t,e={}){let s="";const i=t.indexOf("%");i>0&&(s=t.substring(i),t=t.substring(0,i));const h=function(t){const e=[];let s=0,i=0,h=!1,n=!1;for(;s<t.length;){const r=t.charAt(s);h?'"'===r&&(e.push(t.substring(i,s)),i=s+1,n=!1,h=!1):n?"'"===r&&(e.push(t.substring(i,s)),i=s+1,n=!1,h=!1):" "===r?(i!==s&&e.push(t.substring(i,s)),i=s+1):'"'===r?(i=s+1,h=!0):"'"===r&&(i=s+1,n=!0),++s}return 0===i?e.push(t):i<s&&e.push(t.substring(i)),e}(t);let n="default";h[0]in pt&&(n=h[0],h.shift());const r=pt[n];function a(t){return r.call(this,n,t,h)}const o=a.bind({get:ut});if(s.length)return s.endsWith("d")?function(t,e){const s=/%([\+-]*)(\d*)d/.exec(t)||["","","0"];let i=Number.parseInt(s[2]||"0");const h=s[1].includes("+"),n=s[1].includes("-");return function(t){const s=Number.parseInt(e(t)||"0");let r=""+s;return s>0&&h&&(r="+"+r),i&&n?r.padEnd(i):i?r.padStart(i):r}}(s,o):s.endsWith("f")?function(t,e){const s=/%([\+-]*)(\d*)(\.(\d+))?f/.exec(t)||["","","0"];let i=Number.parseInt(s[2]||"0");const h=s[1].includes("+"),n=s[1].includes("-"),r=Number.parseInt(s[4])||0;return function(t){const s=Number.parseFloat(e(t)||"0");let a;return a=r?s.toFixed(r):""+s,s>0&&h&&(a="+"+a),i&&n?a.padEnd(i):i?a.padStart(i):a}}(s,o):function(t,e){const s=/%(-?\d*)s/.exec(t)||[],i=Number.parseInt(s[1]||"0");return function(t){let s=""+e(t);return i<0?s=s.padEnd(-i):i&&(s=s.padStart(i)),s}}(s,o);return o||(()=>"!!!")}(t,e)));return function(t={}){return"string"==typeof t&&(t={value:t}),h.map((e=>e(t))).join("")}}function mt(t){return()=>t}function yt(t,e,s={}){if(null==t)return;if(!e)return;if(!(t=""+t).length)return;const i=s.eachColor||b,h=s.fg||ft.defaultFg,n=s.bg||ft.defaultBg,r={fg:h,bg:n};i(r);const a=Object.assign({},r);let o=0,d=!1,l=!1,u=0,c="";for(;u<t.length;){const s=t.charAt(u);if(l)"}"===s?(l=!1,d=!1,Object.assign(r,a),i(r)):(e(s,r.fg,r.bg,o,u),++o);else if(d)if(" "===s){l=!0,Object.assign(a,r);const t=c.split(":");t[0].length&&(r.fg=t[0]),t[1]&&(r.bg=t[1]),i(r),c=""}else if("}"===s){d=!1;const t=c.split(":");t[0].length&&(r.fg=t[0]),t[1]&&(r.bg=t[1]),i(r),c=""}else c+=s;else if("#"===s)"{"===t.charAt(u+1)?"}"===t.charAt(u+2)?(u+=2,r.fg=h,r.bg=n,i(r)):(d=!0,u+=1):(e(s,r.fg,r.bg,o,u),++o);else if("\\"===s){u+=1;e(t.charAt(u),r.fg,r.bg,o,u),++o}else e(s,r.fg,r.bg,o,u),++o;++u}l&&console.warn("Ended text without ending inline color!")}function wt(t,e,s={}){if(e<5)return t;let i=e;s.hyphenate&&(!0===s.hyphenate&&(s.hyphenate=Math.floor(e/2)),i=w(s.hyphenate,6,e+1)),s.indent=s.indent||0;const h=" ".repeat(s.indent);let n="",r=null,a=null,o=e;return e-=s.indent,function(t,e,s={}){let i="",h="",n="",r="";yt(t,((t,s,a)=>{s===h&&a===n||(i.length&&(e(i,h,n,r),i="",r=""),h=s,n=a)," "===t?(i.length&&(e(i,h,n,r),i="",r=""),r+=" "):"\n"===t?(i.length&&(e(i,h,n,r),i="",r=""),e("\n",h,n,r),r=""):"-"===t?(i+=t,i.length>3&&(e(i,h,n,r),i="",r="")):i+=t}),s),i&&e(i,h,n,r)}(t,((t,s,d,l)=>{let u=l.length+t.length;if(u>o&&t.length>i){const i=function(t,e,s){let i=0,h=[],n=s||e;for(;i<t.length;){const s=t.length-i;if(n>=s)return h.push(t.substring(i)),h;if(n<4&&(n=e,h.push("")),s<n+e)return h.push(t.substring(i,i+n-1)),h.push(t.substring(i+n-1)),h;const r=Math.min(n-1,Math.floor(s/2)),a=t.substring(i,i+r);h.push(a),i+=r,n=e}return h}(t,e,o-l.length);for(0===i[0].length?(n+="\n",(s||d)&&(n+=`#{${s||""}${d?":"+d:""}}`),o=e,i.shift()):(n+=l,o-=l.length);i.length>1;)n+=i.shift()+"-\n",(s||d)&&(n+=`#{${s||""}${d?":"+d:""}}`),n+=h;return n+=i[0],void(o=e-i[0].length-h.length)}if("\n"===t||u>o){if(n+="\n",(s||d)&&(r="INVALID",a="INVALID"),o=e,n+=h,o-=h.length,"\n"===t)return;l=""}l.length&&(n+=l,o-=l.length),s===r&&d===a||(r=s,a=d,n+=`#{${s||""}${d?":"+d:""}}`),o-=t.length,n+=t})),n}class xt{constructor(t,e){this._clip=null,"number"!=typeof t&&(e=t.height,t=t.width),this._width=t,this._height=e}get width(){return this._width}get height(){return this._height}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}drawSprite(t,e,s){const i=s.ch,h=s.fg,n=s.bg;return this.draw(t,e,i,h,n)}blackOut(...t){return 0==t.length?this.fill(" ",0,0):this.draw(t[0],t[1]," ",0,0)}fill(t=" ",e=4095,s=0){return 1==arguments.length&&(s=H(t),t=null,e=s),this.fillRect(0,0,this.width,this.height,t,e,s)}drawText(t,e,s,i=4095,h=null,n=0,r="left"){if("number"!=typeof i&&(i=H(i)),"number"!=typeof h&&(h=H(h)),n=Math.min(n||this.width,this.width-t),"right"==r){const e=gt(s);t+=n-e}else if("center"==r){const e=gt(s);t+=Math.floor((n-e)/2)}return yt(s,((s,i,h,r)=>{t+r>=this.width||r>=n||this.draw(r+t,e,s,i,h)}),{fg:i,bg:h}),1}wrapText(t,e,s,i,h=4095,n=null,r=0){h=H(h),n=H(n),i=wt(i,s=Math.min(s,this.width-t),{indent:r});let a=0,o=t;for(yt(i,((i,h,n)=>{if("\n"==i){for(;o<t+s;)this.draw(o++,e+a," ",0,n);return++a,void(o=t+r)}this.draw(o++,e+a,i,h,n)}),{fg:h,bg:n});o<t+s;)this.draw(o++,e+a," ",0,n);return a+1}fillBounds(t,e=null,s=null,i=null){return this.fillRect(t.x,t.y,t.width,t.height,e,s,i)}fillRect(t,e,s,i,h=null,n=null,r=null){n=null!==n?H(n):null,r=null!==r?H(r):null;const a=Math.min(t+s,this.width),o=Math.min(e+i,this.height);for(let s=t;s<a;++s)for(let t=e;t<o;++t)this.set(s,t,h,n,r);return this}drawLineH(t,e,s,i,h,n=null){for(let r=0;r<s;++r)this.draw(t+r,e,i,h,n)}drawLineV(t,e,s,i,h,n=null){for(let r=0;r<s;++r)this.draw(t,e+r,i,h,n)}drawProgress(t,e,s,i,h,n,r,a=""){const o=n/r,d=Math.floor(s*o),l=Math.floor(100*(s*o-d));this.fillRect(t,e,d,1,null,null,h),this.draw(t+d,e,null,null,H(h).alpha(l)),a&&a.length&&this.drawText(t,e,a,i,null,s,"center")}blackOutBounds(t,e=0){return this.blackOutRect(t.x,t.y,t.width,t.height,e)}blackOutRect(t,e,s,i,h="black"){return h=H(h),this.fillRect(t,e,s,i," ",h,h)}highlight(t,e,s,i=50){if(!this.hasXY(t,e))return this;s=H(s);const h=new dt,n=this.get(t,e);return h.drawSprite(n),h.fg=h.fg.add(s,i),h.bg=h.bg.add(s,i),this.drawSprite(t,e,h),this}invert(t,e){if(!this.hasXY(t,e))return this;const s=this.get(t,e);return s.fg==s.bg?this.draw(t,e,s.ch,s.bg,H(s.fg).inverse()):this.draw(t,e,s.ch,s.bg,s.fg),this}mix(t,e,s=0,i=0,h=0,n=0){if((t=H(t)).isNull())return this;const r=new dt;h||(h=s?1:this.width),n||(n=i?1:this.height);const a=Math.min(h+s,this.width),o=Math.min(n+i,this.height);for(let h=s;h<a;++h)for(let s=i;s<o;++s){const i=this.get(h,s);r.drawSprite(i),r.fg=r.fg.mix(t,e),r.bg=r.bg.mix(t,e),this.drawSprite(h,s,r)}return this}blend(t,e=0,s=0,i=0,h=0){if((t=H(t)).isNull())return this;const n=new dt;i||(i=e?1:this.width),h||(h=s?1:this.height);const r=Math.min(i+e,this.width),a=Math.min(h+s,this.height);for(let i=e;i<r;++i)for(let e=s;e<a;++e){const s=this.get(i,e);n.drawSprite(s),n.fg=n.fg.blend(t),n.bg=n.bg.blend(t),this.drawSprite(i,e,n)}return this}setClip(...t){return 1==t.length?(this._clip=t[0].clone(),this):(this._clip=new P(t[0],t[1],t[2],t[3]),this)}clearClip(){return this._clip=null,this}}class vt extends xt{constructor(...t){super(t[0],t[1]),this.changed=!1,this._data=[],this.resize(this._width,this._height)}clone(){const t=new this.constructor(this._width,this._height);return t.copy(this),t}resize(t,e){if(this._data.length!==t*e){for(this._width=t,this._height=e;this._data.length<t*e;)this._data.push(new dt);this._data.length=t*e,this.changed=!0}}_index(t,e){return e*this.width+t}get(t,e){if(!this.hasXY(t,e))throw new Error(`Invalid loc - ${t},${e}`);let s=e*this.width+t;return this._data[s]}set(t,e,s=null,i=null,h=null){if(this._clip&&!this._clip.contains(t,e))return this;return this.get(t,e).fill(s,i,h),this}info(t,e){if(!this.hasXY(t,e))throw new Error(`Invalid loc - ${t},${e}`);let s=e*this.width+t;const i=this._data[s];return{ch:i.ch,fg:i.fg.toInt(),bg:i.bg.toInt()}}copy(t){return this._data.forEach(((e,s)=>{e.copy(t._data[s])})),this.changed=!0,this._clip=t._clip?t._clip.clone():null,this}apply(t){return this._clip?(this._clip.forEach(((e,s)=>{const i=this.get(e,s),h=t.get(e,s);i.drawSprite(h)})),this):(this._data.forEach(((e,s)=>{e.drawSprite(t._data[s])})),this.changed=!0,this)}draw(t,e,s=null,i=null,h=null){if(this._clip&&!this._clip.contains(t,e))return this;let n=e*this.width+t;return this._data[n].draw(s,i,h),this.changed=!0,this}nullify(...t){if(0==t.length)this._clip?this._clip.forEach(((t,e)=>{this.nullify(t,e)})):this._data.forEach((t=>t.nullify()));else{if(this._clip&&!this._clip.contains(t[0],t[1]))return this;this.get(t[0],t[1]).nullify()}}dump(){const t=[];let e="    ";for(let t=0;t<this.width;++t)t%10==0&&(e+=" "),e+=t%10;t.push(e),t.push("");for(let e=0;e<this.height;++e){let s=`${(""+e).padStart(2)}] `;for(let t=0;t<this.width;++t){t%10==0&&(s+=" ");let i=this.get(t,e).ch;null===i&&(i=" "),s+=i}t.push(s)}console.log(t.join("\n"))}}class Et{constructor(t,e){this.events=new T(this),this.tweens=new M,this.timers=new C(this),this.all=[],this.children=[],this.focused=null,this.dt=0,this.time=0,this.realTime=0,this.skipTime=!1,this.stopped=!0,this.paused={},this.debug=!1,this._needsDraw=!0,this.bg=G,this.data={},this.id=t,this.styles=new Q,this.app=e,this.buffer=new vt(e.width,e.height),this.styles.setParent(e.styles)}get needsDraw(){return this._needsDraw}set needsDraw(t){t&&(this._needsDraw=!0)}get width(){return this.buffer.width}get height(){return this.buffer.height}isActive(){return!this.stopped}isPaused(){return this.isPaused}isSleeping(){return this.isSleeping}_create(t={}){if(t.bg&&(this.bg=H(t.bg)),t.data){if(!lt(t.data))throw new Error("SceneCreateOpts 'data' field must be plain object.");this.data=ct(this.data,t.data)}t.on&&Object.entries(t.on).forEach((([t,e])=>{this.on(t,e)})),Object.entries(t).forEach((([t,e])=>{"function"==typeof e&&this.on(t,e)})),this.emit("create",t)}destroy(t){this.emit("destroy",t),this.all.forEach((t=>t.destroy())),this.children=[],this.all=[],this.timers.clear(),this.tweens.clear()}switchTo(t={}){return this.app.scenes._switchTo(this,t),this}_start(t={}){this.stopped=!1,this.buffer.nullify(),this.needsDraw=!0,this.events.emit("start",t)}show(t={}){return this.app.scenes.pause(),this._start(t),this.once("stop",(()=>this.app.scenes.resume())),this}stop(t){this.stopped=!0,this.events.emit("stop",t)}pause(t){t=t||{timers:!0,tweens:!0,update:!0,input:!0,draw:!0},Object.assign(this.paused,t),this.events.emit("pause",t)}resume(t){t=t||{timers:!0,tweens:!0,update:!0,input:!0,draw:!0},Object.entries(t).forEach((([t,e])=>{!0===e&&(this.paused[t]=!1)})),this.needsDraw=!0,this.events.emit("resume",t)}frameStart(){this.events.emit("frameStart")}input(t){if(!(this.paused.input||this.stopped||(this.emit("input",t),t.defaultPrevented||t.propagationStopped))){if(t.type===i){let e=this.focused;e&&(e.hidden||e.disabled)&&(this.nextTabStop(),e=this.focused),e&&e.keypress(t),e&&!t.defaultPrevented&&("Tab"===t.key?this.nextTabStop()&&t.stopPropagation():"TAB"===t.key&&this.prevTabStop()&&t.stopPropagation())}else if(t.type===h)this.children.forEach((e=>e.mousemove(t)));else{const e=this.childAt(t);e&&(e.click(t),e.prop("tabStop")&&!t.defaultPrevented&&this.setFocusWidget(e))}t.propagationStopped||t.defaultPrevented||(t.dispatch(this.events),void 0===t.propagationStopped&&void 0===t.defaultPrevented&&t.stopPropagation())}}update(t){this.stopped||(this.paused.timers||this.timers.update(t),this.paused.tweens||this.tweens.update(t),this.paused.update||(this.events.emit("update",t),this.all.forEach((e=>e.update(t)))))}fixed_update(t){this.stopped||this.paused.update||(this.events.emit("fixedUpdate",t),this.all.forEach((e=>e.fixedUpdate(t))))}draw(t){this.stopped||(!this.paused.draw&&this.needsDraw&&(this._draw(this.buffer),this.emit("draw",this.buffer),this.children.forEach((t=>t.draw(this.buffer))),this._needsDraw=!1),t.apply(this.buffer),this.buffer.changed=!1)}_draw(t){t.fill(this.bg)}frameDebug(t){this.events.emit("frameDebug",t)}frameEnd(t){this.events.emit("frameEnd",t)}fadeIn(t,e){return this.fadeTo(t,100,e)}fadeOut(t,e){return this.fadeTo(t,0,e)}fadeTo(t,e,s){const i=nt({pct:t.style("opacity")}).to({pct:e}).duration(s).onUpdate((e=>{t.style("opacity",e.pct)}));return this.tweens.add(i),this}fadeToggle(t,e){return this.fadeTo(t,t._used.opacity?0:100,e)}slideIn(t,e,s,i,h){let n={x:e,y:s};return"left"===i?n.x=-t.bounds.width:"right"===i?n.x=this.width+t.bounds.width:"top"===i?n.y=-t.bounds.height:"bottom"===i&&(n.y=this.height+t.bounds.height),this.slide(t,n,{x:e,y:s},h)}slideOut(t,e,s){let i={x:t.bounds.x,y:t.bounds.y};return"left"===e?i.x=-t.bounds.width:"right"===e?i.x=this.width+t.bounds.width:"top"===e?i.y=-t.bounds.height:"bottom"===e&&(i.y=this.height+t.bounds.height),this.slide(t,t.bounds,i,s)}slide(t,e,s,i){const h=nt({x:R(e),y:I(e)}).to({x:R(s),y:I(s)}).duration(i).onUpdate((e=>{t.pos(e.x,e.y)}));return this.tweens.add(h),this}get(t){return this.all.find((e=>e.id===t))||null}_attach(t){if(!this.all.includes(t)){if(t.scene)throw new Error("Widget on another scene!");this.all.push(t),t.scene=this,t.children.forEach((t=>this._attach(t))),!t.prop("tabStop")||this.focused||t.hidden||t.disabled||this.setFocusWidget(t)}}_detach(t){const e=this.all.indexOf(t);e<0||(this.all.splice(e,1),t.scene=null,t.children.forEach((t=>this._detach(t))))}addChild(t,e){this.children.includes(t)||(t.setParent(null),this.children.push(t),this._attach(t),e&&(t.updatePos(e),e.focused&&this.setFocusWidget(t)))}removeChild(t){const e=this.children.indexOf(t);e<0||(this.children.splice(e,1),t.setParent(null),this._detach(t))}childAt(t,e){let s=0;return"number"==typeof t?(s=t,e=e||0):(s=t.x,e=t.y),E(this.children,(t=>t.contains(s,e)))||null}widgetAt(t,e){let s=0;return"number"==typeof t?(s=t,e=e||0):(s=t.x,e=t.y),E(this.all,(t=>t.contains(s,e)))||null}setFocusWidget(t,e=!1){if(t===this.focused)return;const s=this.focused,i=t;this.focused=null,s&&s.blur(e),null===this.focused&&(this.focused=i,i&&i.focus(e))}nextTabStop(){if(!this.focused)return this.setFocusWidget(this.all.find((t=>!!t.prop("tabStop")&&!t.disabled&&!t.hidden))||null),!!this.focused;const t=S(this.all,this.focused,(t=>!!t.prop("tabStop")&&!t.disabled&&!t.hidden));return t?(this.setFocusWidget(t),!0):(this.setFocusWidget(null),!1)}prevTabStop(){if(!this.focused)return this.setFocusWidget(this.all.find((t=>!!t.prop("tabStop")&&!t.disabled&&!t.hidden))||null),!!this.focused;const t=function(t,e,s,i=!0){return S(t,e,s,i,!1)}(this.all,this.focused,(t=>!!t.prop("tabStop")&&!t.disabled&&!t.hidden));return t?(this.setFocusWidget(t,!0),!0):(this.setFocusWidget(null,!0),!1)}on(...t){return 1===t.length?this.events.on(t[0]):this.events.on(t[0],t[1])}once(t,e){return this.events.once(t,e)}emit(t,...e){return this.events.emit(t,...e)}wait(t,e,s){if("string"==typeof e){const t=e;s=s||{},e=()=>this.emit(t,s)}return this.timers.setTimeout(e,t)}repeat(t,e,...s){if("string"==typeof e){const t=e;e=()=>this.emit(t,...s)}return this.timers.setInterval(e,t)}}class St{constructor(t){this._active=[],this._busy=!1,this._pending=[],this._app=t,this._config=Object.assign({},Tt)}get isBusy(){return this._busy}config(...t){if(1===t.length){const e=t[0];return void Object.entries(e).forEach((([t,e])=>this.config(t,e)))}let[e,s]=t;const i=this._config[e]||{};"function"==typeof s&&(s={make:s}),Object.assign(i,s),this._config[e]=i}get(t){return void 0===t?this._active[this._active.length-1]:this._active.find((e=>e.id===t))||null}emit(t,...e){this._active.forEach((s=>s.emit(t,...e)))}create(t,e={}){const s=ct(this._config[t]||{},e);let i;return i=s.make?s.make(t,this._app):new Et(t,this._app),i.on("start",(()=>this._started(i))),i.on("stop",(()=>this._stopped(i))),i._create(s),i}switchTo(t,e){let s=t instanceof Et?t:this.create(t,{});return this._switchTo(s,e),s}_switchTo(t,e={}){this._app.io.clear(),this.stop(),this.isBusy?this._pending.push({action:"_start",scene:t,data:e}):t._start(e)}show(t,e){let s=t instanceof Et?t:this.create(t,e);return this._app.io.clear(),this.isBusy?this._pending.push({action:"show",scene:s,data:e}):s.show(e),s}_started(t){this._active.push(t)}stop(t,e){if("string"==typeof t){const e=this.get(t);if(!e)throw new Error("Unknown scene:"+t);t=e}t instanceof Et?this.isBusy?this._pending.push({action:"stop",scene:t,data:e}):t.stop(e):this._active.forEach((e=>this.stop(e.id,t)))}_stopped(t){this._active=this._active.filter((t=>t.isActive()))}destroy(t,e){const s=this.get(t);s&&(s.isActive()&&s.stop(e),s.destroy(e))}pause(t,e){if("string"==typeof t){const s=this.get(t);if(!s)throw new Error("Unknown scene:"+t);s.pause(e)}else this._active.forEach((e=>e.pause(t)))}resume(t,e){if("string"==typeof t){const s=this.get(t);if(!s)throw new Error("Unknown scene:"+t);s.resume(e)}else this._active.forEach((e=>e.resume(t)))}frameStart(){this._busy=!0,this._active.forEach((t=>t.frameStart()))}input(t){!function(t,e){for(let s=t.length-1;s>-1;--s)e(t[s],s,t)}(this._active,(e=>{t.propagationStopped||e.input(t)}))}update(t){this._active.forEach((e=>e.update(t)))}fixed_update(t){this._active.forEach((e=>e.fixed_update(t)))}draw(t){this._active.forEach((e=>{e.draw(t)}))}frameDebug(t){this._active.length&&this._active.forEach((e=>e.frameDebug(t)))}frameEnd(t){this._active.length&&this._active.forEach((e=>e.frameEnd(t))),this._busy=!1;for(let t=0;t<this._pending.length;++t){const e=this._pending[t];e.scene[e.action](e.data)}this._pending.length=0}}const Tt={};function kt(t,e){"function"==typeof e&&(e={make:e}),Tt[t]=e}const Ct="\n#version 300 es\n\nin vec2 position;\nin uvec2 offset;\nin uint fg;\nin uint bg;\nin uint glyph;\n\nout vec2 fsOffset;\nout vec4 fgRgb;\nout vec4 bgRgb;\nflat out uvec2 fontPos;\n\nuniform int depth;\n\nvoid main() {\n\tfloat fdepth = float(depth) / 255.0;\n\tgl_Position = vec4(position, fdepth, 1.0);\n\n\tfloat fgr = float((fg & uint(0xF000)) >> 12);\n\tfloat fgg = float((fg & uint(0x0F00)) >> 8);\n\tfloat fgb = float((fg & uint(0x00F0)) >> 4);\n\tfloat fga = float((fg & uint(0x000F)) >> 0);\n\tfgRgb = vec4(fgr, fgg, fgb, fga) / 15.0;\n  \n\tfloat bgr = float((bg & uint(0xF000)) >> 12);\n\tfloat bgg = float((bg & uint(0x0F00)) >> 8);\n\tfloat bgb = float((bg & uint(0x00F0)) >> 4);\n\tfloat bga = float((bg & uint(0x000F)) >> 0);\n\tbgRgb = vec4(bgr, bgg, bgb, bga) / 15.0;\n\n\tuint glyphX = (glyph & uint(0xF));\n\tuint glyphY = (glyph >> 4);\n\tfontPos = uvec2(glyphX, glyphY);\n\n\tfsOffset = vec2(offset);\n}".trim(),Mt="\n#version 300 es\nprecision highp float;\n\nin vec2 fsOffset;\nin vec4 fgRgb;\nin vec4 bgRgb;\nflat in uvec2 fontPos;\n\nout vec4 fragColor;\n\nuniform sampler2D font;\nuniform uvec2 tileSize;\n\nvoid main() {\n\tuvec2 fontPx = (tileSize * fontPos) + uvec2(vec2(tileSize) * fsOffset);\n\tvec4 texel = texelFetch(font, ivec2(fontPx), 0).rgba;\n\n\tfragColor = vec4(mix(bgRgb.rgb, fgRgb.rgb, texel.rgb), mix(bgRgb.a, fgRgb.a, texel.r));\n}".trim();class At{static fromImage(t){if("string"==typeof t){if(t.startsWith("data:"))throw new Error("Glyph: You must load a data string into an image element and use that.");const e=document.getElementById(t);if(!e)throw new Error("Glyph: Failed to find image element with id:"+t);t=e}const e=new this({tileWidth:t.width/16,tileHeight:t.height/16});return e._ctx.drawImage(t,0,0),e}static fromFont(t){"string"==typeof t&&(t={font:t});const e=new this(t),s=t.basicOnly||t.basic||!1;return(t.init||Rt)(e,s),e}constructor(t={}){this._tileWidth=12,this._tileHeight=16,this.needsUpdate=!0,this._toGlyph={},this._toChar=[],t.font=t.font||"monospace",this._node=document.createElement("canvas"),this._ctx=this.node.getContext("2d"),this._configure(t)}get node(){return this._node}get ctx(){return this._ctx}get tileWidth(){return this._tileWidth}get tileHeight(){return this._tileHeight}get pxWidth(){return this._node.width}get pxHeight(){return this._node.height}forChar(t){return t&&t.length&&this._toGlyph[t]||-1}toChar(t){return this._toChar[t]||" "}_configure(t){this._tileWidth=t.tileWidth||this.tileWidth,this._tileHeight=t.tileHeight||this.tileHeight,this.node.width=16*this.tileWidth,this.node.height=16*this.tileHeight,this._ctx.fillStyle="black",this._ctx.fillRect(0,0,this.pxWidth,this.pxHeight);const e=t.fontSize||t.size||Math.min(this.tileWidth,this.tileHeight);this._ctx.font=e+"px "+t.font,this._ctx.textAlign="center",this._ctx.textBaseline="middle",this._ctx.fillStyle="white"}draw(t,e){if(t>=256)throw new Error("Cannot draw more than 256 glyphs.");const s=t%16*this.tileWidth,i=Math.floor(t/16)*this.tileHeight,h=s+Math.floor(this.tileWidth/2),n=i+Math.floor(this.tileHeight/2);this._ctx.save(),this._ctx.beginPath(),this._ctx.rect(s,i,this.tileWidth,this.tileHeight),this._ctx.clip(),this._ctx.fillStyle="black",this._ctx.fillRect(s,i,this.tileWidth,this.tileHeight),this._ctx.fillStyle="white","function"==typeof e?e(this._ctx,s,i,this.tileWidth,this.tileHeight):(void 0===this._toGlyph[e]&&(this._toGlyph[e]=t),this._toChar[t]=e,this._ctx.fillText(e,h,n)),this._ctx.restore(),this.needsUpdate=!0}}function Rt(t,e=!1){for(let e=32;e<127;++e)t.draw(e,String.fromCharCode(e));[" ","☺","☻","♥","♦","♣","♠","☼","☀","☆","★","‣","∙","⁃","•","☰","☷","☐","☑","☒","⚬","⦿","↑","→","↓","←","↔","↕","▲","▶","▼","◀"].forEach(((e,s)=>{t.draw(s,e)})),e||["⌂","Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","¢","£","¥","₧","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","⌐","¬","½","¼","¡","«","»","░","▒","▓","│","┤","╡","╢","╖","╕","╣","║","╗","╝","╜","╛","┐","└","┴","┬","├","─","┼","╞","╟","╚","╔","╩","╦","╠","═","╬","╧","╨","╤","╥","╙","╘","╒","╓","╫","╪","┘","┌","█","▄","▌","▐","▀","α","ß","Γ","π","Σ","σ","µ","τ","Φ","Θ","Ω","δ","∞","φ","ε","∩","≡","±","≥","≤","⌠","⌡","÷","≈","°","∙","·","√","ⁿ","²","■","§"].forEach(((e,s)=>{t.draw(s+127,e)}))}class It extends xt{constructor(t,e=0){super(t.width,t.height),this._empty=!0,this.canvas=t,this.resize(t.width,t.height),this._depth=e}get width(){return this.canvas.width}get height(){return this.canvas.height}get depth(){return this._depth}get empty(){return this._empty}detach(){this.canvas=null}resize(t,e){const s=t*e*Pt;this.fg&&this.fg.length===s||(this.fg=new Uint16Array(s),this.bg=new Uint16Array(s),this.glyph=new Uint8Array(s))}clear(){this.fg.fill(0),this.bg.fill(0),this.glyph.fill(0),this._empty=!0}get(t,e){const s=t*e*Pt;return{ch:this.fromGlyph(this.glyph[s]),fg:U(this.fg[s]),bg:U(this.bg[s])}}set(t,e,s=null,i=4095,h=-1){return this.draw(t,e,s,i,h)}draw(t,e,s=null,i=4095,h=-1){const n=t+e*this.canvas.width;return"string"==typeof s?s=this.toGlyph(s):null===s&&(s=this.glyph[n]),i=H(i).toInt(),h=H(h).toInt(),this._set(n,s,i,h),(s||h||i)&&(this._empty=!1,this.canvas._requestRender()),this}_set(t,e,s,i){t*=Pt,e&=255,i&=65535,s&=65535;for(let h=0;h<Pt;++h)this.glyph[t+h]=e,this.fg[t+h]=s,this.bg[t+h]=i}nullify(...t){2===t.length?this._set(t[0]*t[1],0,0,0):(this.glyph.fill(0),this.fg.fill(0),this.bg.fill(0))}dump(){const t=[];let e="    ";for(let t=0;t<this.width;++t)t%10==0&&(e+=" "),e+=t%10;t.push(e),t.push("");for(let e=0;e<this.height;++e){let s=`${(""+e).padStart(2)}] `;for(let t=0;t<this.width;++t){t%10==0&&(s+=" ");let i=this.get(t,e).ch;null===i&&(i=" "),s+=i}t.push(s)}console.log(t.join("\n"))}copy(t){if(t.width===this.width&&t.height===this.height||(console.log("auto resizing buffer"),t.resize(this.width,this.height)),!this.canvas)throw new Error("Layer is detached.  Did you resize the canvas?");t._data.forEach(((t,e)=>{let s="string"==typeof t.ch?this.canvas.glyphs.forChar(t.ch):t.ch||0;this._set(e,s,t.fg.toInt(),t.bg.toInt())})),this._empty=!1,this.canvas._requestRender()}copyTo(t){t.resize(this.width,this.height);for(let e=0;e<this.height;++e)for(let s=0;s<this.width;++s){const i=(s+e*this.width)*Pt;t.draw(s,e,this.toChar(this.glyph[i]),this.fg[i],this.bg[i])}}toGlyph(t){return this.canvas.glyphs.forChar(t)}fromGlyph(t){return this.canvas.glyphs.toChar(t)}toChar(t){return this.canvas.glyphs.toChar(t)}}const Pt=6;class Ot extends Error{constructor(...t){super(...t),Error.captureStackTrace&&Error.captureStackTrace(this,Ot),this.name="NotSupportedError"}}class Dt{constructor(t){if(this.mouse={x:-1,y:-1},this._renderRequested=!1,this._autoRender=!0,this._width=50,this._height=25,this._layers=[],!t.glyphs)throw new Error("You must supply glyphs for the canvas.");this._node=this._createNode(),this._createContext(),this._configure(t)}get node(){return this._node}get width(){return this._width}get height(){return this._height}get tileWidth(){return this._glyphs.tileWidth}get tileHeight(){return this._glyphs.tileHeight}get pxWidth(){return this.node.clientWidth}get pxHeight(){return this.node.clientHeight}get glyphs(){return this._glyphs}set glyphs(t){this._setGlyphs(t)}layer(t=0){let e=this._layers.find((e=>e.depth===t));return e||(e=new It(this,t),this._layers.push(e),this._layers.sort(((t,e)=>t.depth-e.depth)),e)}clearLayer(t=0){const e=this._layers.find((e=>e.depth===t));e&&e.clear()}removeLayer(t=0){const e=this._layers.findIndex((e=>e.depth===t));e>-1&&this._layers.splice(e,1)}_createNode(){return document.createElement("canvas")}_configure(t){if(this._width=t.width||this._width,this._height=t.height||this._height,this._autoRender=!1!==t.render,this._setGlyphs(t.glyphs),this.bg=H(t.bg||G),t.div){let e;"string"==typeof t.div?(e=document.getElementById(t.div),e||console.warn("Failed to find parent element by ID: "+t.div)):e=t.div,e&&e.appendChild&&e.appendChild(this.node)}}_setGlyphs(t){if(t===this._glyphs)return!1;this._glyphs=t,this.resize(this._width,this._height);const e=this._gl,s=this._uniforms;return e.uniform2uiv(s.tileSize,[this.tileWidth,this.tileHeight]),this._uploadGlyphs(),!0}resize(t,e){this._width=t,this._height=e;const s=this.node;s.width=this._width*this.tileWidth,s.height=this._height*this.tileHeight;this._gl.viewport(0,0,this.node.width,this.node.height),this._createGeometry(),this._createData()}_requestRender(){this._renderRequested||(this._renderRequested=!0,this._autoRender&&requestAnimationFrame((()=>this._render())))}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}toX(t){return Math.floor(this.width*t/this.node.clientWidth)}toY(t){return Math.floor(this.height*t/this.node.clientHeight)}set onclick(t){this.node.onclick=t?e=>{const s=this.toX(e.offsetX),i=this.toY(e.offsetY);t(e,s,i),e.preventDefault()}:null}set onmousemove(t){this.node.onmousemove=t?e=>{const s=this.toX(e.offsetX),i=this.toY(e.offsetY);s==this.mouse.x&&i==this.mouse.y||(this.mouse.x=s,this.mouse.y=i,t(e,s,i),e.preventDefault())}:null}set onkeydown(t){t?(this.node.tabIndex=0,this.node.onkeydown=e=>{e.stopPropagation(),t(e),e.preventDefault()}):this.node.onkeydown=null}_createContext(){let t=this.node.getContext("webgl2");if(!t)throw new Ot("WebGL 2 not supported");this._gl=t,this._buffers={},this._attribs={},this._uniforms={};const e=function(t,...e){const s=t.createProgram();if([t.VERTEX_SHADER,t.FRAGMENT_SHADER].forEach(((i,h)=>{const n=t.createShader(i);if(t.shaderSource(n,e[h]),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(n));t.attachShader(s,n)})),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(s));return s}(t,Ct,Mt);t.useProgram(e);const s=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let i=0;i<s;i++){t.enableVertexAttribArray(i);let s=t.getActiveAttrib(e,i);this._attribs[s.name]=i}const i=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let s=0;s<i;s++){let i=t.getActiveUniform(e,s);this._uniforms[i.name]=t.getUniformLocation(e,i.name)}t.uniform1i(this._uniforms.font,0),this._texture=function(t){let e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),e}(t)}_createGeometry(){const t=this._gl;this._buffers.position&&t.deleteBuffer(this._buffers.position),this._buffers.uv&&t.deleteBuffer(this._buffers.uv);let e=function(t,e,s,i){let h=s*i,n=new Float32Array(h*Ft.length),r=new Uint8Array(h*Ft.length);for(let t=0;t<i;t++)for(let e=0;e<s;e++){const h=(e+t*s)*Ft.length;n.set(Ft.map(((h,n)=>n%2?1-2*(t+h)/i:2*(e+h)/s-1)),h),r.set(Ft,h)}const a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.vertexAttribPointer(e.position,2,t.FLOAT,!1,0,0),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW);const o=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,o),t.vertexAttribIPointer(e.offset,2,t.UNSIGNED_BYTE,0,0),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),{position:a,uv:o}}(t,this._attribs,this.width,this.height);Object.assign(this._buffers,e)}_createData(){const t=this._gl,e=this._attribs;this._buffers.fg&&t.deleteBuffer(this._buffers.fg),this._buffers.bg&&t.deleteBuffer(this._buffers.bg),this._buffers.glyph&&t.deleteBuffer(this._buffers.glyph),this._layers.length&&(this._layers.forEach((t=>t.detach())),this._layers.length=0);const s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.vertexAttribIPointer(e.fg,1,t.UNSIGNED_SHORT,0,0);const i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.vertexAttribIPointer(e.bg,1,t.UNSIGNED_SHORT,0,0);const h=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,h),t.vertexAttribIPointer(e.glyph,1,t.UNSIGNED_BYTE,0,0),Object.assign(this._buffers,{fg:s,bg:i,glyph:h})}_uploadGlyphs(){if(!this._glyphs.needsUpdate)return;const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._glyphs.node),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),this._requestRender(),this._glyphs.needsUpdate=!1}draw(t,e,s,i,h){this.layer(0).draw(t,e,s,i,h)}render(t){t&&this.layer().copy(t),this._requestRender()}_render(){const t=this._gl;if(this._glyphs.needsUpdate)this._uploadGlyphs();else if(!this._renderRequested)return;this._renderRequested=!1,t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.clearColor(this.bg.r255/100,this.bg.g255/100,this.bg.b255/100,this.bg.a/100),t.clear(t.COLOR_BUFFER_BIT),this._layers.forEach((e=>{e.empty||(t.uniform1i(this._uniforms.depth,e.depth),t.bindBuffer(t.ARRAY_BUFFER,this._buffers.fg),t.bufferData(t.ARRAY_BUFFER,e.fg,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this._buffers.bg),t.bufferData(t.ARRAY_BUFFER,e.bg,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this._buffers.glyph),t.bufferData(t.ARRAY_BUFFER,e.glyph,t.DYNAMIC_DRAW),t.drawArrays(t.TRIANGLES,0,this._width*this._height*Pt))}))}}const Ft=[0,0,1,0,0,1,0,1,1,0,1,1];Math.random.bind(Math);class Nt extends Z{constructor(t){super(t),this._text="",this._lines=[],this._fixedWidth=!1,this._fixedHeight=!1,this._fixedHeight=!!t.height,this._fixedWidth=!!t.width,this.bounds.width=t.width||0,this.bounds.height=t.height||1,this.text(t.text||"")}text(t){if(void 0===t)return this._text;this._text=t;let e=this._fixedWidth?this.bounds.width:this.scene?this.scene.width:100;return this._lines=function(t,e=200,s={}){return"string"!=typeof t?[]:wt(t=t.trimEnd(),e,s).split("\n")}(this._text,e),this._fixedWidth||(this.bounds.width=this._lines.reduce(((t,e)=>Math.max(t,gt(e))),0)),this._fixedHeight?this._lines.length>this.bounds.height&&(this._lines.length=this.bounds.height):this.bounds.height=Math.max(1,this._lines.length),this.needsDraw=!0,this}resize(t,e){return super.resize(t,e),this._fixedWidth=t>0,this._fixedHeight=e>0,this.text(this._text),this}addChild(){throw new Error("Text widgets cannot have children.")}_draw(t){super._draw(t);let e=0;"bottom"===this._used.valign?e=this.bounds.height-this._lines.length:"middle"===this._used.valign&&(e=Math.floor((this.bounds.height-this._lines.length)/2)),this._lines.forEach(((s,i)=>{t.drawText(this.bounds.x,this.bounds.y+i+e,s,this._used.fg,-1,this.bounds.width,this._used.align)}))}}class Bt extends Nt{constructor(t){super((()=>{if(t.text=t.text||"",t.tabStop=void 0===t.tabStop||t.tabStop,t.tag=t.tag||"button",!t.text&&!t.width)throw new Error("Buttons must have text or width.");return 0==t.text.length&&(t.width=t.width||2),t})()),this.on("click",this.action.bind(this)),this.on("Enter",this.action.bind(this))}}class Wt extends Z{constructor(t){super(t),this.ascii=!1,(t.ascii||t.fg&&!1!==t.ascii)&&(this.ascii=!0)}contains(){return!1}_draw(t){super._draw(t);const e=this.bounds.width,s=this.bounds.height,i=this.bounds.x,h=this.bounds.y,n=this.ascii;return jt(t,i,h,e,s,this._used,n),!0}}function jt(t,e,s,i,h,n,r=!0){const a=n.fg||null,o=n.bg||null;if(r){for(let n=1;n<i;++n)t.draw(e+n,s,"-",a,o),t.draw(e+n,s+h-1,"-",a,o);for(let n=1;n<h;++n)t.draw(e,s+n,"|",a,o),t.draw(e+i-1,s+n,"|",a,o);t.draw(e,s,"+",a,o),t.draw(e+i-1,s,"+",a,o),t.draw(e,s+h-1,"+",a,o),t.draw(e+i-1,s+h-1,"+",a,o)}else!function(...t){let e=0,s=0;arguments.length>3&&(e=t.shift(),s=t.shift());const i=e+t[0]-1,h=s+t[1]-1,n=t[2];for(let t=e;t<=i;++t)n(t,s),n(t,h);for(let t=s;t<=h;++t)n(e,t),n(i,t)}(e,s,i,h,((e,s)=>{t.draw(e,s," ",o,o)}))}function Lt(t){if(!t)return[0,0,0,0];if(!0===t)return[1,1,1,1];if("number"==typeof t)return[t,t,t,t];if(1==t.length){const e=t[0];return[e,e,e,e]}if(2==t.length){const[e,s]=t;return[e,s,e,s]}throw new Error("Invalid pad: "+t)}J.add("dialog",{bg:"darkest_gray",fg:"light_gray"});class Ut extends Z{static{this.default={tag:"dialog",border:"none",pad:!1,legendTag:"legend",legendClass:"",legendAlign:"left"}}constructor(t){super((t.tag=t.tag||Ut.default.tag,t)),this.legend=null;let e=t.border||Ut.default.border;this.attr("border",e);const s=Lt(t.pad||Ut.default.pad);if(this.attr("padTop",s[0]),this.attr("padRight",s[1]),this.attr("padBottom",s[2]),this.attr("padLeft",s[3]),"none"!==e)for(let t=0;t<4;++t)s[t]+=1;this._adjustBounds(s),this.attr("legendTag",t.legendTag||Ut.default.legendTag),this.attr("legendClass",t.legendClass||t.class||Ut.default.legendClass),this.attr("legendAlign",t.legendAlign||Ut.default.legendAlign),this._addLegend(t)}_adjustBounds(t){return this.bounds.width+=t[1]+t[3],this.bounds.height+=t[0]+t[2],this.bounds.x-=t[3],this.bounds.y-=t[0],this}get _innerLeft(){const t=this._attrStr("border"),e=this._attrInt("padLeft");return this.bounds.x+e+("none"===t?0:1)}get _innerWidth(){const t=this._attrStr("border"),e=this._attrInt("padLeft")+this._attrInt("padRight");return this.bounds.width-e-("none"===t?0:2)}get _innerTop(){const t=this._attrStr("border"),e=this._attrInt("padTop");return this.bounds.y+e+("none"===t?0:1)}get _innerHeight(){const t=this._attrStr("border"),e=this._attrInt("padTop")+this._attrInt("padBottom");return this.bounds.height-e-("none"===t?0:2)}_addLegend(t){if(!t.legend)return"none"===this._attrStr("border")&&(this.bounds.height=0),this;const e="none"!==this._attrStr("border"),s=gt(t.legend),i=this.bounds.width-(e?4:0),h=this._attrStr("legendAlign");let n=this.bounds.x+(e?2:0);return"center"===h?n+=Math.floor((i-s)/2):"right"===h&&(n+=i-s),this.legend=new Nt({parent:this,text:t.legend,x:n,y:this.bounds.y,tag:this._attrStr("legendTag"),class:this._attrStr("legendClass")}),this.bounds.height=Math.max(1,this.bounds.height),this}_draw(t){super._draw(t);const e=this._attrStr("border");return"none"!==e&&(jt(t,this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this._used,"ascii"===e),!0)}}J.add("input",{bg:"light_gray",fg:"black",align:"left",valign:"top"}),J.add("input:invalid",{fg:"red"}),J.add("input:empty",{fg:"darkest_green"}),J.add("input:focus",{bg:"lighter_gray"});class Yt extends Nt{static{this.default={tag:"input",width:10,placeholder:""}}constructor(t){super((t.text=t.text||"",t.tag=t.tag||"input",t.tabStop=void 0===t.tabStop||t.tabStop,t.width=t.width||t.maxLength||Math.max(t.minLength||0,10),t)),this.minLength=0,this.maxLength=0,this.numbersOnly=!1,this.min=0,this.max=0,this.attr("default",this._text),this.attr("placeholder",t.placeholder||Yt.default.placeholder),t.numbersOnly?(this.numbersOnly=!0,this.min=t.min||0,this.max=t.max||0):(this.minLength=t.minLength||0,this.maxLength=t.maxLength||0),t.required&&(this.attr("required",!0),this.prop("required",!0)),t.disabled&&(this.attr("disabled",!0),this.prop("disabled",!0)),this.prop("valid",this.isValid()),this.on("blur",(()=>this.action())),this.reset()}reset(){this.text(this._attrStr("default"))}_setProp(t,e){super._setProp(t,e),this._props.valid=this.isValid()}isValid(){const t=this._text||"";if(this.numbersOnly){const e=Number.parseInt(t);return!(void 0!==this.min&&e<this.min)&&(!(void 0!==this.max&&e>this.max)&&e>0)}const e=Math.max(this.minLength,this.prop("required")?1:0);return t.length>=e&&(!this.maxLength||t.length<=this.maxLength)}keypress(t){if(!t.key)return;const e=this.numbersOnly?["0","9"]:[" ","~"];return"Enter"===t.key&&this.isValid()?(this.action(),this.scene&&this.scene.nextTabStop(),void t.stopPropagation()):"Delete"==t.key||"Backspace"==t.key?(this._text.length&&(this.text(function(t,e,s,i=""){const h=t.length;if(e>=h)return t;const n=t.substring(0,e);return e+s>=h?n:n+i+t.substring(e+s)}(this._text,this._text.length-1,1)),this.emit("change"),this._used&&this._draw(this.scene.buffer)),void t.stopPropagation()):void(l(t)||(t.key>=e[0]&&t.key<=e[1]&&(!this.maxLength||this._text.length<this.maxLength)&&(this.text(this._text+t.key),this.emit("change"),this._used&&this._draw(this.scene.buffer)),t.stopPropagation()))}click(t){if(this.disabled||this.hidden)return;t.target=this;const e=this.childAt(t);e&&e.click(t),this.bounds.contains(t)&&(t.propagationStopped||t.dispatch(this.events))}text(t){return void 0===t?this._text:(super.text(t),this.prop("empty",0===this._text.length),this.prop("valid",this.isValid()),this)}_draw(t,e=!1){this._drawFill(t);let s=0;this._used&&("bottom"===this._used.valign?s=this.bounds.height-this._lines.length:"middle"===this._used.valign&&(s=Math.floor((this.bounds.height-this._lines.length)/2)));let i=this._text;0==i.length&&(i=this._attrStr("placeholder")),this._text.length>this.bounds.width&&(i=this._text.slice(this._text.length-this.bounds.width));const h=this._used?this._used.fg:"white",n=this._used?this._used.align:"left";return t.drawText(this.bounds.x,this.bounds.y+s,i,h,-1,this.bounds.width,n),!0}}const Ht={create(){this.on("mousemove",(t=>{t.stopPropagation()})),this.on("click",(t=>{t.stopPropagation()})),this.on("keypress",(t=>{t.stopPropagation()})),this.on("PROMPT",(()=>{const t=this.get("PROMPT");this.stop(t?t.text():null)})),this.on("Escape",(()=>{this.stop(null)}))},start(t){t.class=t.class||"confirm",t.border=t.border||"ascii",t.pad=t.pad||0;const e=void 0!==t.opacity?t.opacity:50;this.bg=G.alpha(e);const s=new Nt({text:t.prompt,class:t.textClass||t.class,width:t.width,height:t.height});Object.assign(t,{width:s.bounds.width+2,height:s.bounds.height+1,x:s.bounds.x-1,y:s.bounds.y-1,tag:"inputbox",scene:this,center:!0});const i=new Ut(t);s.setParent(i,{top:1,centerX:!0});let h=i._innerWidth-2,n=s.bounds.left;if(t.label){const e=new Nt({parent:i,text:t.label,class:t.labelClass||t.class,tag:"label",x:n,bottom:-1});n+=e.bounds.width+1,h-=e.bounds.width+1}const r=new Yt({parent:i,class:t.inputClass||t.class,width:h,id:"PROMPT",x:n,bottom:-1});this.once("PROMPT",(()=>{t.done&&t.done(r.text())})),this.once("Escape",(()=>{t.done&&t.done(null)}))},stop(){this.children.forEach((t=>t.destroy())),this.children=[]}};kt("prompt",Ht);class Xt{constructor(t={div:"game"}){if(this.dt=16,this.time=0,this.realTime=0,this.skipTime=!1,this.fps=0,this.fpsBuf=[],this.fpsTimer=0,this.numFrames=0,this.loopId=0,this.stopped=!0,this.paused=!1,this.debug=!1,"number"==typeof t.seed&&t.seed>0&&N.seed(t.seed),"loop"in t?(this.loop=t.loop,delete t.loop):this.loop=new k,this.name=t.name||"Goblinwerks",this.styles=J,this.canvas=t.canvas||function(...t){let e,s=t[0],i=t[1],h=t[2];1==t.length&&(h=t[0],i=h.height||34,s=h.width||80),h=h||{font:"monospace"},e=h.image?At.fromImage(h.image):At.fromFont(h);const n=new Dt({width:s,height:i,glyphs:e});if(h.div){let t;"string"==typeof h.div?(t=document.getElementById(h.div),t||console.warn("Failed to find parent element by ID: "+h.div)):t=h.div,t&&t.appendChild&&t.appendChild(n.node)}return n}(t),this.io=new _,this.events=new T(this),this.timers=new C(this),this.scenes=new St(this),void 0!==t.dt&&(this.dt=t.dt||16),this.data=ct({},t.data||{}),this.canvas.onmousemove=(t,e,s)=>{const i=g(t,e,s);this.io.enqueue(i)},this.canvas.onclick=(t,e,s)=>{const i=g(t,e,s);this.io.enqueue(i)},this.canvas.onkeydown=t=>{const e=f(t);this.io.enqueue(e)},this.buffer=new vt(this.canvas.width,this.canvas.height),t.scenes)this.scenes.config(t.scenes),"string"==typeof t.scene?this.scenes.switchTo(t.scene,t.sceneStartOpts):this.scenes.switchTo(Object.keys(t.scenes)[0],t.sceneStartOpts);else if(t.scene){if("string"==typeof t.scene)throw new Error("Cannot use string 'scene' option without including 'scenes'.");!0===t.scene&&(t.scene={}),this.scenes.config("default",t.scene),this.scenes.switchTo("default",t.sceneStartOpts)}!1!==t.start&&this.start(),globalThis.APP=this,qt=this}get width(){return this.canvas.width}get height(){return this.canvas.height}get node(){return this.canvas.node}get mouseXY(){return this.canvas.mouse}get scene(){return this.scenes.get()}on(t,e){return this.events.on(t,e)}emit(t,...e){this.scenes.emit(t,...e),this.events.emit(t,...e)}wait(...t){if("string"==typeof t[1]){const e=t[1];t[2]=t[2]||{},t[1]=()=>this.emit(e,t[2])}return this.timers.setTimeout(t[1],t[0])}repeat(...t){if("string"==typeof fn){const e=t[1];t[2]=t[2]||{},t[1]=()=>this.emit(e,t[2])}return this.timers.setInterval(t[1],t[0])}start(){return this.loop.isRunning||this.loop.start(this._frame.bind(this)),this}stop(){this.emit("stop",this),this.loop.stop(),this.stopped=!0}_frame(t=0){if(t=t||Date.now(),"undefined"!=typeof document&&"visible"!==document.visibilityState)return;0==this.realTime&&(this.realTime=t,this.time=t);const e=t,s=e-this.realTime;for(this.realTime=e,this.skipTime||(this.fpsBuf.push(1e3/s),this.fpsTimer+=s,this.fpsTimer>=1&&(this.fpsTimer=0,this.fps=Math.round(this.fpsBuf.reduce(((t,e)=>t+e))/this.fpsBuf.length),this.fpsBuf=[])),this.skipTime=!1,this.numFrames++,this._frameStart();this.io.length;){const t=this.io.dequeue();this._input(t)}if(!this.paused&&!0!==this.debug){for(;this.time+this.dt<=e;)this.time+=this.dt,this._fixed_update(this.dt);this._update(s)}this._draw(),!1!==this.debug&&this._frameDebug(),this._frameEnd(),this.io.clear()}_input(t){this.scenes.input(t),t.propagationStopped||t.defaultPrevented||t.dispatch(this.events)}_update(t=0){t=t||this.dt,this.scenes.update(t),this.timers.update(t),this.events.emit("update",t)}_fixed_update(t=0){t=t||this.dt,this.scenes.fixed_update(t),this.events.emit("fixed_update",t)}_frameStart(){this.scenes.frameStart(),this.events.emit("frameStart")}_draw(){this.scenes.draw(this.buffer),this.events.emit("draw",this.buffer)}_frameDebug(){this.scenes.frameDebug(this.buffer),this.events.emit("frameDebug",this.buffer)}_frameEnd(){this.scenes.frameEnd(this.buffer),this.events.emit("frameEnd",this.buffer),this.canvas.render(this.buffer)}alert(t,e={}){return e.text=t,this.scenes.show("alert",e)}show(t,e){return this.scenes.show(t,e)}switchTo(t,e){return this.scenes.switchTo(t,e)}confirm(t,e={}){return e.text=t,this.scenes.show("confirm",e)}prompt(t,e={}){e.prompt=t;const s=this.scenes.create("prompt",Ht);return s.show(e),s}}function Kt(t){return new Xt(t)}var qt,Gt=Object.freeze({__proto__:null,App:Xt,CLICK:n,ComputedStyle:V,Event:e,EventQueue:_,Events:T,KEYPRESS:i,Loop:k,MOUSEMOVE:h,MOUSEUP:a,STOP:o,Scene:Et,Scenes:St,Selector:A,Sheet:Q,Style:$,TICK:r,Timers:C,Tweens:M,Widget:Z,get active(){return qt},alignChildren:tt,compile:function(t){return new A(t)},defaultStyle:J,ignoreKeyEvent:function(t){return d.includes(t.code)},installScene:kt,isControlCode:l,keyCodeDirection:p,make:Kt,makeCustomEvent:c,makeKeyEvent:f,makeMouseEvent:g,makeStopEvent:function(){return c(o)},makeStyle:function(t,e="$"){const s={};return t.trim().split(";").map((t=>t.trim())).forEach((t=>{const[e,i]=t.split(":").map((t=>t.trim()));if(!e)return;const h=i.split(/ +/g);1==h.length?s[e]=i:s[e]=h})),new $(e,s)},makeTickEvent:function(t){const e=c(r);return e.dt=t,e},recycleEvent:u,scenes:Tt,spaceChildren:et,start:function(t){return Kt(t)},wrapChildren:st});class zt extends Ut{static{this.default={tag:"fieldset",border:"none",separator:" : ",pad:!1,legendTag:"legend",legendClass:"legend",legendAlign:"left",labelTag:"label",labelClass:"",dataTag:"field",dataClass:""}}constructor(t){super((t.tag=t.tag||zt.default.tag,t.border=t.border||zt.default.border,t.legendTag=t.legendTag||zt.default.legendTag,t.legendClass=t.legendClass||zt.default.legendClass,t.legendAlign=t.legendAlign||zt.default.legendAlign,t.width=t.width||0,t.height=t.height||0,t)),this.fields=[],this.attr("separator",t.separator||zt.default.separator),this.attr("dataTag",t.dataTag||zt.default.dataTag),this.attr("dataClass",t.dataClass||zt.default.dataClass),this.attr("dataWidth",t.dataWidth),this.attr("labelTag",t.labelTag||zt.default.labelTag),this.attr("labelClass",t.labelClass||zt.default.labelClass),this.attr("labelWidth",this._innerWidth-t.dataWidth),this._addLegend(t)}_adjustBounds(t){return this.bounds.width=Math.max(this.bounds.width,t[1]+t[3]),this.bounds.height=Math.max(this.bounds.height,t[0]+t[2]),this}get _labelLeft(){const t=this._attrStr("border"),e=this._attrInt("padLeft");return this.bounds.x+e+("none"===t?0:1)}get _dataLeft(){return this._labelLeft+this._attrInt("labelWidth")}get _nextY(){let t="none"===this._attrStr("border")?0:1;const e=this._attrInt("padBottom");return this.bounds.bottom-t-e}add(t,e){const s=this._attrStr("separator"),i=_t(t,this._attrInt("labelWidth")-s.length," ")+s;new Nt({parent:this,text:i,x:this._labelLeft,y:this._nextY,width:this._attrInt("labelWidth"),tag:this._attrStr("labelTag"),class:this._attrStr("labelClass")}),"string"==typeof e&&(e={format:e}),e.x=this._dataLeft,e.y=this._nextY,e.width=this._attrInt("dataWidth"),e.tag=e.tag||this._attrStr("dataTag"),e.class=e.class||this._attrStr("dataClass"),e.parent=this;const h=new $t(e);return this.bounds.height+=1,this.fields.push(h),this}_setData(t){super._setData(t),this.fields.forEach((e=>e.format(t)))}_setDataItem(t,e){super._setDataItem(t,e),this.fields.forEach((t=>t.format(e)))}}class $t extends Nt{constructor(t){super((()=>{const e=t;return e.tag=e.tag||"field",e.text="",e})()),"string"==typeof t.format?this._format=bt(t.format):this._format=t.format}format(t){const e=this._format(t)||"";return this.text(e)}}class Vt extends Z{static{this.default={pad:1}}constructor(t){super((t.tag=t.tag||"ol",t)),this._fixedWidth=!1,this._fixedHeight=!1,this._fixedHeight=!!t.height,this._fixedWidth=!!t.width,this.prop("pad",t.pad||Vt.default.pad)}addChild(t){return t.bounds.x=this.bounds.x+2,this._fixedHeight||(t.bounds.y=this.bounds.bottom-2,this.bounds.height+=t.bounds.height),this._fixedWidth?t.bounds.width=Math.min(t.bounds.width,this.bounds.width-4):t.bounds.width>this.bounds.width-4&&(this.bounds.width=t.bounds.width+4),super.addChild(t)}_draw(t){return this._drawFill(t),this.children.forEach(((e,s)=>{this._drawBulletFor(e,t,s)})),!0}_getBullet(t){return""+(t+1)}_drawBulletFor(t,e,s){const i=this._getBullet(s),h=this._attrInt("pad")+i.length,n=t.bounds.x-h,r=t.bounds.y;e.drawText(n,r,i,t._used.fg,t._used.bg,h)}}class Qt extends Vt{static{this.default={bullet:"•",pad:1}}constructor(t){super((t.tag=t.tag||"ul",t)),this.prop("bullet",t.bullet||Qt.default.bullet),this.prop("pad",t.pad||Qt.default.pad)}_getBullet(t){return this._attrStr("bullet")}}J.add("datatable",{bg:"black"}),J.add("td:selected",{bg:"gray"});class Jt{constructor(t){this.format=y,this.width=t.width||Zt.default.columnWidth,"function"==typeof t.format?this.format=t.format:t.format&&(this.format=bt(t.format)),this.header=t.header||"",this.headerTag=t.headerTag||Zt.default.headerTag,this.empty=t.empty||Zt.default.empty,this.dataTag=t.dataTag||Zt.default.dataTag}addHeader(t,e,s,i){const h=new Nt({parent:t,x:e,y:s,class:t.classes.join(" "),tag:t._attrStr("headerTag"),width:this.width,height:t.rowHeight,text:this.header});return h.prop("row",-1),h.prop("col",i),h}addData(t,e,s,i,h,n){let r;r=Array.isArray(e)?""+(e[h]||this.empty):"object"!=typeof e?""+e:this.format(e),""===r&&(r=this.empty);const a=new Nt({parent:t,text:r,x:s,y:i,class:t.classes.join(" "),tag:t._attrStr("dataTag"),width:this.width,height:t.rowHeight});return a.on("mouseenter",(()=>{t.select(h,n)})),a.prop(n%2==0?"even":"odd",!0),a.prop("row",n),a.prop("col",h),a}addEmpty(t,e,s,i,h){return this.addData(t,[],e,s,i,h)}}class Zt extends Z{static{this.default={columnWidth:10,header:!0,empty:"",tag:"datatable",headerTag:"th",dataTag:"td",select:"cell",hover:"select",prefix:"none",border:"ascii",wrap:!0}}constructor(t){super((t.tag=t.tag||Zt.default.tag,t.tabStop=void 0===t.tabStop||t.tabStop,t.data?Array.isArray(t.data)||(t.data=[t.data]):t.data=[],t)),this.columns=[],this.showHeader=!1,this.rowHeight=1,this.selectedRow=-1,this.selectedColumn=0,this.size=t.size||(this.parent?this.parent.bounds.height:this.scene?this.scene.height:0),this.bounds.width=0,t.columns.forEach((t=>{const e=new Jt(t);this.columns.push(e),this.bounds.width+=e.width})),t.border?!0===t.border&&(t.border="ascii"):!1===t.border&&(t.border="none"),this.attr("border",t.border||Zt.default.border),this.rowHeight=t.rowHeight||1,this.bounds.height=1,this.attr("wrap",void 0===t.wrap?Zt.default.wrap:t.wrap),this.attr("header",void 0===t.header?Zt.default.header:t.header),this.attr("headerTag",t.headerTag||Zt.default.headerTag),this.attr("dataTag",t.dataTag||Zt.default.dataTag),this.attr("prefix",t.prefix||Zt.default.prefix),this.attr("select",t.select||Zt.default.select),this.attr("hover",t.hover||Zt.default.hover),this._setData(this._data)}get selectedData(){if(!(this.selectedRow<0))return this._data[this.selectedRow]}select(t,e){if(!this._data||0==this._data.length)return this.selectedRow=this.selectedColumn=0,this;this.attr("wrap")&&((t<0||t>=this.columns.length)&&(t+=this.columns.length,t%=this.columns.length),(e<0||e>=this._data.length)&&(e+=this._data.length,e%=this._data.length)),t=this.selectedColumn=w(t,0,this.columns.length-1),e=this.selectedRow=w(e,0,this._data.length-1);const s=this._attrStr("select");return"none"===s?this.children.forEach((t=>{t.prop("selected",!1)})):"row"===s?this.children.forEach((t=>{const s=e==t.prop("row");t.prop("selected",s)})):"column"===s?this.children.forEach((e=>{const s=t==e.prop("col");e.prop("selected",s)})):"cell"===s&&this.children.forEach((s=>{const i=t==s.prop("col")&&e==s.prop("row");s.prop("selected",i)})),this.emit("change",{row:e,col:t,data:this.selectedData}),this}selectNextRow(){return this.select(this.selectedColumn,this.selectedRow+1)}selectPrevRow(){return this.select(this.selectedColumn,this.selectedRow-1)}selectNextCol(){return this.select(this.selectedColumn+1,this.selectedRow)}selectPrevCol(){return this.select(this.selectedColumn-1,this.selectedRow)}blur(t){return this.emit("change",{col:this.selectedColumn,row:this.selectedRow,data:this.selectedData}),super.blur(t)}_setData(t){this._data=t;for(let t=this.children.length-1;t>=0;--t){const e=this.children[t];e.tag!==this.attr("headerTag")&&this.removeChild(e)}const e="none"!==this.attr("border")?1:0;let s=this.bounds.x+e,i=this.bounds.y+e;return this.attr("header")&&(this.columns.forEach(((t,h)=>{t.addHeader(this,s,i,h),s+=t.width+e})),i+=this.rowHeight+e),this._data.forEach(((t,h)=>{h>=this.size||(s=this.bounds.x+e,this.columns.forEach(((n,r)=>{n.addData(this,t,s,i,r,h),s+=n.width+e})),i+=this.rowHeight+e)})),0==this._data.length?(s=this.bounds.x+e,this.columns.forEach(((t,h)=>{t.addEmpty(this,s,i,h,0),s+=t.width+e})),i+=1,this.select(-1,-1)):this.select(0,0),this.bounds.height=i-this.bounds.y,this.bounds.width=s-this.bounds.x,this.needsStyle=!0,this}_draw(t){return this._drawFill(t),this.children.forEach((e=>{e._propInt("row")>=this.size||"none"!==this.attr("border")&&jt(t,e.bounds.x-1,e.bounds.y-1,e.bounds.width+2,e.bounds.height+2,this._used,"ascii"==this.attr("border"))})),!0}keypress(t){return!!t.key&&(t.dir?this.dir(t):"Enter"===t.key&&(this.action(t),!0))}dir(t){return!!t.dir&&(1==t.dir[1]?this.selectNextRow():-1==t.dir[1]&&this.selectPrevRow(),1==t.dir[0]?this.selectNextCol():-1==t.dir[0]&&this.selectPrevCol(),!0)}}class te extends Zt{constructor(t){super((()=>{const e=t;return"none"!==t.border&&t.width&&(t.width-=2),e.columns=[Object.assign({},t)],t.header&&t.header.length||(e.header=!1),e})())}}class ee extends Z{static{this.default={tag:"menu",class:"",buttonClass:"",buttonTag:"mi",marker:" ▶",minWidth:4}}constructor(t){super((t.tag=t.tag||ee.default.tag,t.class=t.class||ee.default.class,t.tabStop=void 0===t.tabStop||t.tabStop,t)),this._selectedIndex=0,Array.isArray(t.buttonClass)?this.attr("buttonClass",t.buttonClass.join(" ")):this.attr("buttonClass",t.buttonClass||ee.default.buttonClass),this.attr("buttonTag",t.buttonTag||ee.default.buttonTag),this.attr("marker",t.marker||ee.default.marker),this._initButtons(t),this.bounds.height=this.children.length,this.on("mouseenter",(t=>(this.children.forEach((e=>{e.contains(t)?e.expand():e.collapse()})),!0))),this.on("dir",(t=>{t.dir&&(t.dir[0]<0?this.hide():t.dir[0]>0?this.expandItem():t.dir[1]<0?this.prevItem():t.dir[1]>0&&this.nextItem(),t.stopPropagation())})),this.on(["Enter"," "],(()=>{this.children[this._selectedIndex].action(),this.hide()}))}_initButtons(t){this.children=[];const e=t.buttons,s=this._attrStr("marker"),i=Object.entries(e);this.bounds.width=Math.max(t.minWidth||0,this.bounds.width,i.reduce(((t,[e,i])=>{const h=gt(e)+("string"==typeof i?0:s.length);return Math.max(t,h)}),0)),i.forEach((([t,e],i)=>{const h={x:this.bounds.x,y:this.bounds.y+i,class:this._attrStr("buttonClass"),tag:this._attrStr("buttonTag"),width:this.bounds.width,height:1,buttons:e,text:t,parent:this};"string"==typeof e?h.action=e:h.text=_t(t,this.bounds.width-s.length," ")+s;const n=new se(h);n.on("mouseenter",(()=>{this.emit("change")})),n.on("click",(()=>{this.hide()})),n.menu&&n.menu.on("hide",(()=>{this.scene.setFocusWidget(this)}))}))}show(){this.hidden=!1,this._selectedIndex=0,this.scene.setFocusWidget(this),this.emit("show")}hide(){this.hidden=!0,this.emit("hide")}nextItem(){++this._selectedIndex,this._selectedIndex>=this.children.length&&(this._selectedIndex=0)}prevItem(){--this._selectedIndex,this._selectedIndex<0&&(this._selectedIndex=this.children.length-1)}expandItem(){return this.children[this._selectedIndex].expand()}selectItemWithKey(t){let e=!1;this.children.forEach((s=>{e||s.text().startsWith(t)&&(e=!0)}))}}class se extends Nt{constructor(t){super((t.tag=t.tag||"mi",t.tabStop=!1,t)),this.menu=null,"string"!=typeof t.buttons&&(this.menu=this._initMenu(t),this.on("mouseenter",(()=>{this.menu.hidden=!1,this.menu.emit("change")})),this.on("mouseleave",((t,e,s)=>{this.parent?.bounds.contains(s)&&(this.menu.hidden=!0)})),this.on("click",(()=>!0))),this.on("click",this.action.bind(this))}collapse(){this.menu&&this.menu.hide()}expand(){return this.menu?(this.menu.show(),this.menu):null}_setMenuPos(t,e){t.x=this.bounds.x+this.bounds.width,t.y=this.bounds.y;const s=Object.keys(e.buttons).length;this.scene&&t.y+s>=this.scene.height&&(t.y=this.scene.height-s-1)}_initMenu(t){if("string"==typeof t.buttons)return null;const e={x:this.bounds.x+this.bounds.width,y:this.bounds.y,class:t.class,tag:t.tag||"mi",buttons:t.buttons};this._setMenuPos(e,t),e.parent=this;const s=new ee(e);return s.hidden=!0,s}}class ie extends Z{static{this.default={buttonClass:"",buttonTag:"mi",menuClass:"",menuTag:"mi",prefix:" ",separator:" | "}}constructor(t){super((t.tabStop=!1,t.tag=t.tag||"menu",t)),t.buttonClass?Array.isArray(t.buttonClass)?this.attr("buttonClass",t.buttonClass.join(" ")):this.attr("buttonClass",t.buttonClass):this.attr("buttonClass",ie.default.buttonClass),this.attr("buttonTag",t.buttonTag||ie.default.buttonTag),t.menuClass?Array.isArray(t.menuClass)?this.attr("menuClass",t.menuClass.join(" ")):this.attr("menuClass",t.menuClass):this.attr("menuClass",ie.default.menuClass),this.attr("menuTag",t.menuTag||ie.default.menuTag),this.attr("prefix",t.prefix||ie.default.prefix),this.attr("separator",t.separator||ie.default.separator),this.bounds.height=1,this._initButtons(t)}_initButtons(t){const e=Object.entries(t.buttons),s=this._attrStr("buttonTag"),i=this._attrStr("buttonClass");let h=this.bounds.x;const n=this.bounds.y;e.forEach((([t,e],r)=>{const a=0==r?this._attrStr("prefix"):this._attrStr("separator");new Nt({parent:this,text:a,x:h,y:n}),h+=a.length,this.bounds.width+=a.length;const o=new Bt({parent:this,id:t,text:t,x:h,y:n,tag:s,class:i});h+=o.bounds.width,this.bounds.width+=o.bounds.width;let d=null;"string"!=typeof e&&(d=new ee({buttons:e,buttonClass:this._attrStr("menuClass"),buttonTag:this._attrStr("menuTag"),x:o.bounds.x,y:o.bounds.y+1}),o.data("menu",d)),o.on(["click","Enter"," "],(()=>{"string"==typeof e?(this.emit(e),this.scene.emit(e)):this.scene.app.scenes.show("menu",{menu:d,origin:this.scene})}))}))}}class he extends Z{static{this.default={tag:"choice",border:"ascii",promptTag:"prompt",promptClass:"",choiceTag:"ci",choiceClass:"",infoTag:"info",infoClass:""}}constructor(t){super((t.tag=t.tag||he.default.tag,t)),this._prompt=null,this._done=null,this.choiceWidth=t.choiceWidth,this.attr("border",t.border||he.default.border),this.attr("promptTag",t.promptTag||he.default.promptTag),this.attr("promptClass",t.promptClass||he.default.promptClass),this.attr("choiceTag",t.choiceTag||he.default.choiceTag),this.attr("choiceClass",t.choiceClass||he.default.choiceClass),this.attr("infoTag",t.infoTag||he.default.infoTag),this.attr("infoClass",t.infoClass||he.default.infoClass),this._addLegend(),this._addList(),this._addInfo(),t.prompt&&this.showPrompt(t.prompt)}get prompt(){return this._prompt}showPrompt(t,e){return this._prompt=t,t.choose(0),this._text.text(t.prompt(e)),this._list.data(t.choices()),this._info.text(t.info(e)),this.emit("prompt",this._prompt),new Promise((t=>this._done=t))}_addList(){return this._list=new te({parent:this,height:this.bounds.height-2,x:this.bounds.x+1,width:this.choiceWidth,y:this.bounds.y+1,dataTag:this._attrStr("choiceTag"),dataClass:this._attrStr("choiceClass"),tabStop:!0,border:"none",hover:"select"}),this._list.on("change",(()=>{if(!this._prompt)return!1;const t=this._prompt,e=this._list.selectedRow;t.choose(e),this._info.text(t.info()),this.emit("change",t)})),this._list.on("action",(()=>{if(!this._prompt)return!1;const t=this._prompt;t.choose(this._list.selectedRow),this.action(),this._done(t.value())})),this}_addInfo(){return this._info=new Nt({parent:this,text:"",x:this.bounds.x+this.choiceWidth+2,y:this.bounds.y+1,width:this.bounds.width-this.choiceWidth-3,height:this.bounds.height-2,tag:this._attrStr("infoTag"),class:this._attrStr("infoClass")}),this}_addLegend(){return this._text=new Nt({parent:this,text:"",width:this.bounds.width-4,x:this.bounds.x+2,y:this.bounds.y,tag:this._attrStr("promptTag"),class:this._attrStr("promptClass")}),this}_draw(t){let e=this.choiceWidth+2;const s=this.bounds.height;let i=this.bounds.x;const h=this.bounds.y,n="ascii"===this.attr("border");return jt(t,i,h,e,s,this._used,n),e=this.bounds.width-this.choiceWidth-1,i=this.bounds.x+this.choiceWidth+1,jt(t,i,h,e,s,this._used,n),!0}}class ne extends Nt{static{this.default={uncheck:"☐",check:"☒",pad:1,value:"on"}}constructor(t){super((t.tag=t.tag||"checkbox",t.tabStop=void 0===t.tabStop||t.tabStop,t)),this.attr("uncheck",t.uncheck||ne.default.uncheck),this.attr("check",t.check||ne.default.check),this.attr("pad",t.pad??ne.default.pad),this.attr("offValue",""),Array.isArray(t.value)?(this.attr("offValue",t.value[0]||""),this.attr("value",t.value[1]||ne.default.value)):this.attr("value",t.value||ne.default.value),this.bounds.width+=this._attrInt("pad"),t.checked&&this.prop("checked",!0),this.on("click",(t=>{t.defaultPrevented||this.toggleProp("checked")}))}value(){return this._propBool("checked")?this._attrStr("value"):this._attrStr("offValue")}text(t){return void 0===t?super.text():(super.text(t),this.bounds.width+=1+this._attrInt("pad"),this)}keypress(t){t.key&&(super.keypress(t),t.defaultPrevented||("Enter"===t.key||" "===t.key?(this.toggleProp("checked"),this.emit("change")):"Backspace"!==t.key&&"Delete"!==t.key||(this.prop("checked",!1),this.emit("change"))))}_draw(t){const e=this._used.fg||z,s=this._used.bg||q,i=this._used.align;t.fillBounds(this.bounds," ",0,s);const h=this.prop("checked")?"check":"uncheck";let n=""+this._attrs[h];t.drawText(this.bounds.x,this.bounds.y,n,e,s);let r=0;"bottom"===this._used.valign?r=this.bounds.height-this._lines.length:"middle"===this._used.valign&&(r=Math.floor((this.bounds.height-this._lines.length)/2));const a=this._attrInt("pad")+1;return this._lines.forEach(((h,n)=>{t.drawText(this.bounds.x+a,this.bounds.y+n+r,h,e,s,this.bounds.width-a,i)})),!0}}var re=Object.freeze({__proto__:null,Border:Wt,Builder:class{constructor(t){this._opts={x:0,y:0},this.scene=t,this._opts.scene=t}reset(){return this._opts={x:0,y:0,scene:this.scene},this}fg(t){return this._opts.fg=t,this}bg(t){return this._opts.bg=t,this}dim(t=25,e=!0,s=!1){return e&&(this._opts.fg=H(this._opts.fg||"white").darken(t)),s&&(this._opts.bg=H(this._opts.bg||"black").darken(t)),this}bright(t=25,e=!0,s=!1){return e&&(this._opts.fg=H(this._opts.fg||"white").lighten(t)),s&&(this._opts.bg=H(this._opts.bg||"black").lighten(t)),this}invert(){return[this._opts.fg,this._opts.bg]=[this._opts.bg,this._opts.fg],this}style(t){return Object.assign(this._opts,t),this}class(t){return this._opts.class=this._opts.class||"",this._opts.class+=" "+t,this}pos(t,e){return void 0===t?this._opts:(this._opts.x=w(t,0,this.scene.width),this._opts.y=w(e,0,this.scene.height),this)}moveTo(t,e){return this.pos(t,e)}move(t,e){return this._opts.x=w(this._opts.x+t,0,this.scene.width),this._opts.y=w(this._opts.y+e,0,this.scene.height),this}up(t=1){return this.move(0,-t)}down(t=1){return this.move(0,t)}left(t=1){return this.move(-t,0)}right(t=1){return this.move(t,0)}nextLine(t=1){return this.pos(0,this._opts.y+t)}prevLine(t=1){return this.pos(0,this._opts.y-t)}clear(t){return this.scene.destroy(),this.scene.bg=t?H(t):q,this}text(t={},e){"string"==typeof t?(e=e||{}).text=t:e=t;const s=Object.assign({},this._opts,e),i=new Nt(s);return this.move(0,1),i}border(t){const e=Object.assign({},this._opts,t),s=new Wt(e);return this.move(1,1),s}button(t){const e=Object.assign({},this._opts,t),s=new Bt(e);return this.move(0,1),s}checkbox(t){const e=Object.assign({},this._opts,t),s=new ne(e);return this.move(0,1),s}input(t){const e=Object.assign({},this._opts,t),s=new Yt(e);return this.move(0,1),s}fieldset(t){const e=Object.assign({},this._opts,t),s=new zt(e);return this.move(1,1),s}datatable(t){const e=Object.assign({},this._opts,t),s=new Zt(e);return this.move(0,s.bounds.height),s}datalist(t){const e=Object.assign({},this._opts,t),s=new te(e);return this.move(0,s.bounds.height),s}menubar(t){const e=Object.assign({},this._opts,t),s=new ie(e);return this.move(0,s.bounds.height),s}},Button:Bt,Choice:he,Column:Jt,DataList:te,DataTable:Zt,Dialog:Ut,Field:$t,Fieldset:zt,Input:Yt,Inquiry:class{constructor(t){this._prompts=[],this.events={},this._result={},this._stack=[],this._current=null,this.widget=t,this._keypress=this._keypress.bind(this),this._change=this._change.bind(this)}prompts(t,...e){return Array.isArray(t)?this._prompts=t.slice():(e.unshift(t),this._prompts=e),this}_finish(){this.widget.off("keypress",this._keypress),this.widget.off("change",this._change),this._fireEvent("finish",this.widget,this._result)}_cancel(){this.widget.off("keypress",this._keypress),this.widget.off("change",this._change),this._fireEvent("cancel",this.widget)}start(){this._current=this._prompts[0],this._result={},this.widget.on("keypress",this._keypress),this.widget.on("change",this._change),this.widget.showPrompt(this._current,this._result)}back(){this._current.reset(),this._current=this._stack.pop()||null,this._current?(this._current.reset(),this._result={},this._prompts.forEach((t=>t.updateResult(this._result))),this.widget.showPrompt(this._current,this._result)):this._cancel()}restart(){this._prompts.forEach((t=>t.reset())),this._result={},this._current=this._prompts[0],this.widget.showPrompt(this._current,this._result)}quit(){this._cancel()}_keypress(t,e,s){return!!s.key&&("Escape"===s.key?(this.back(),!0):"R"===s.key?(this.restart(),!0):"Q"===s.key&&(this.quit(),!0))}_change(t,e,s){s.updateResult(this._result);const i=s.next();return i&&(this._current=this._prompts.find((t=>t.id()===i))||null,this._current)?(this._stack.push(s),this.widget.showPrompt(this._current,this._result),this._fireEvent("step",this.widget,{prompt:this._current,data:this._result}),!0):(this._finish(),!0)}on(t,e){let s=this.events[t];return s||(s=this.events[t]=[]),s.includes(e)||s.push(e),this}off(t,e){let s=this.events[t];return s?(e?x(s,e):s.length=0,this):this}_fireEvent(t,e,s){const i=this.events[t]||[];let h=!1;for(let n of i)h=n(t,e||this.widget,s)||h;return h||(h=this.widget.emit(t,s)),h}},Menu:ee,MenuButton:se,Menubar:ie,OrderedList:Vt,Prompt:class{constructor(t,e={}){this._id=null,this._defaultNext=null,this.selection=-1,"string"==typeof e&&(e={field:e}),this._prompt=t,this._field=e.field||"",this._choices=[],this._infos=[],this._values=[],this._next=[],this._defaultNext=e.next||null,this._id=e.id||e.field||""}reset(){this.selection=-1}field(t){return void 0===t?this._field:(this._field=t,this)}id(t){return void 0===t?this._id:(this._id=t,this)}prompt(t){return"string"==typeof this._prompt?this._prompt:this._prompt(t)}next(t){return void 0===t?this._next[this.selection]||this._defaultNext:(this._defaultNext=t,this)}choices(t,e){if(void 0===t)return this._choices;if(Array.isArray(t)?Array.isArray(e)||(e=new Array(t.length).fill("")):(e=Object.values(t),t=Object.keys(t)),e=e.map((t=>"string"==typeof t?{info:t}:t)),t.length!==e.length)throw new Error("Choices and Infos must have same length.");return t.forEach(((t,s)=>{this.choice(t,e[s])})),this}choice(t,e={}){return"string"==typeof e&&(e={info:e}),this._choices.push(t),this._infos.push(e.info||""),this._next.push(e.next||null),this._values.push(e.value||t),this}info(t){const e=this._infos[this.selection]||"";return"string"==typeof e?e:e(t)}choose(t){return this.selection=t,this}value(){return this._values[this.selection]}updateResult(t){return this.selection<0||(t[this._field]=this.value()),this}},Select:class extends Z{constructor(t){super((t.tag=t.tag||"select",t)),this._initText(t),this._initMenu(t),this.bounds.height=1}_initText(t){this.dropdown=new Nt({parent:this,text:t.text+" ▼",x:this.bounds.x,y:this.bounds.y,class:t.class,tag:t.tag||"select",width:this.bounds.width,height:1}),this.dropdown.on("click",(()=>(this.menu.toggleProp("hidden"),!1)))}_initMenu(t){this.menu=new ee({parent:this,x:this.bounds.x,y:this.bounds.y+1,class:t.buttonClass,tag:t.buttonTag||"select",width:t.width,minWidth:this.dropdown.bounds.width,height:t.height,buttons:t.buttons}),this.menu.on("click",(()=>(this.menu.hidden=!0,!1))),this.menu.hidden=!0}},Text:Nt,UnorderedList:Qt,Widget:Z,alignChildren:tt,dialog:function(t){return new Ut(t)},drawBorder:jt,make:function(t){const e=new Z(t);return t.with&&Object.entries(t.with).forEach((([t,s])=>{e[t]=s})),e},spaceChildren:et,toPadArray:Lt,wrapChildren:st});const ae={create(){this.on("mousemove",(t=>{t.stopPropagation()})),this.on("click",(t=>{t.stopPropagation(),this.stop({click:!0})})),this.on("keypress",(t=>{t.stopPropagation(),this.stop({keypress:!0})}))},start(t){t.args&&(t.text=function(t,e={}){return bt(t)(e)}(t.text,t.args)),t.class=t.class||"alert",t.border=t.border||"ascii",t.pad=t.pad||1;const e=new Nt(t);t.height||(t.height=e.bounds.height),t.width||(t.width=e.bounds.width),t.scene=this,t.center=!0;const s=new Ut(t);e.setParent(s,{center:!0}),t.waitForAck||this.wait(t.duration||3e3,(()=>this.stop({})))},stop(){this.children.forEach((t=>t.destroy())),this.children=[],this.timers.clear()}};kt("alert",ae);const oe={create(){this.on("keypress",(t=>{"Escape"===t.key?this.emit("CANCEL"):"Enter"===t.key&&this.emit("OK")})),this.on("OK",(()=>{this.stop(!0)})),this.on("CANCEL",(()=>{this.stop(!1)}))},start(t){t.class=t.class||"confirm",t.border=t.border||"ascii",t.pad=t.pad||1;const e=void 0!==t.opacity?t.opacity:50;this.bg=G.alpha(e),void 0===t.cancel||!0===t.cancel?t.cancel="Cancel":t.cancel||(t.cancel=""),t.ok=t.ok||"Ok";let s=t.buttonWidth||0;s||(s=Math.max(t.ok.length,t.cancel.length));const i=Math.max(t.width||0,2*s+2),h=new Nt({scene:this,text:t.text,class:t.textClass||t.class,width:i,height:t.height}).center();Object.assign(t,{scene:this,width:h.bounds.width+2,height:h.bounds.height+2,x:h.bounds.x,y:h.bounds.y,tag:"confirm"});const n=new Ut(t);if(n.addChild(h),new Bt({parent:n,text:t.ok,class:t.okClass||t.class,width:s,id:"OK",right:-1-n._attrInt("padRight"),bottom:-1-n._attrInt("padBottom")}),t.cancel.length&&new Bt({parent:n,text:t.cancel,class:t.cancelClass||t.class,width:s,id:"CANCEL",left:1+n._attrInt("padLeft"),bottom:-1-n._attrInt("padBottom")}),t.done){const e=t.done;this.once("OK",(()=>{e(!0)})),this.once("CANCEL",(()=>{e(!1)}))}},stop(){this.children.forEach((t=>t.destroy())),this.children=[]}};kt("confirm",oe);const de={create(){this.on("click",(()=>{this.stop()})),this.on("Escape",(()=>{this.stop()}))},start(t){if(!t.menu)throw new Error("Must supply a menu to show!");this.addChild(t.menu),this.events.onUnhandled=(e,...s)=>{t.origin.emit(e,...s)}},stop(){this.children=[]}};kt("menu",de);var le=Object.freeze({__proto__:null,AlertScene:ae,ConfirmScene:oe,MenuScene:de,PromptScene:Ht});t.App=Xt,t.BaseObj=it,t.Tween=ht,t.app=Gt,t.interpolate=ot,t.linear=at,t.make=nt,t.move=rt,t.scenes=le,t.widgets=re}));
//# sourceMappingURL=gw-app.min.js.map
